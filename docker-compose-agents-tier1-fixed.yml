version: '3.9'

# Tier 1: Critical Infrastructure Agents - FIXED VERSION
# Total Memory: ~1.5GB (reduced for hardware constraints)
# These agents are essential for system operation and resource management

networks:
  sutazai-network:
    external: true
    name: sutazaiapp_sutazai-network

services:
  # 1. Ollama Integration Specialist - Core model management
  ollama-integration-specialist:
    build:
      context: ./agents/ollama-integration
      dockerfile: Dockerfile
    container_name: sutazai-ollama-specialist
    restart: unless-stopped
    environment:
      - OLLAMA_HOST=http://sutazai-ollama:11434
      - OPENAI_API_BASE=http://sutazai-litellm:4000
      - OPENAI_API_KEY=local
      - LOG_LEVEL=INFO
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - ./models:/models
      - ./config/ollama:/config
      - /var/run/docker.sock:/var/run/docker.sock:rw
    networks:
      - sutazai-network
    user: root  # Fix for Docker socket permissions
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M  # Reduced from 512M
        reservations:
          cpus: '0.25'
          memory: 192M  # Reduced from 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8520/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      - sutazai-ollama-check

  # 2. LiteLLM Proxy Manager - API compatibility layer
  litellm-proxy-manager:
    build:
      context: ./agents/litellm-manager
      dockerfile: Dockerfile
    container_name: sutazai-litellm-manager
    restart: unless-stopped
    environment:
      - LITELLM_HOST=http://host.docker.internal:4000
      - DATABASE_URL=postgresql://sutazai:sutazai_password@sutazai-postgres:5432/sutazai
      - TELEMETRY=false
      - LOG_LEVEL=INFO
    volumes:
      - ./config/litellm:/config
      - ./logs/litellm:/logs
    networks:
      - sutazai-network
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8521/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      - sutazai-postgres-check

  # 3. Infrastructure DevOps Manager - Container and system management
  infrastructure-devops-manager:
    build:
      context: ./agents/infrastructure-devops
      dockerfile: Dockerfile
    container_name: sutazai-devops-manager
    restart: unless-stopped
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - MONITORING_ENABLED=true
      - PROMETHEUS_URL=http://sutazai-prometheus:9090
      - GRAFANA_URL=http://sutazai-grafana:3000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - ./scripts:/scripts:ro
      - ./logs/devops:/logs
    networks:
      - sutazai-network
    user: root  # Fix for Docker socket permissions
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M  # Reduced from 512M
        reservations:
          cpus: '0.25'
          memory: 192M  # Reduced from 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8522/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      - sutazai-prometheus-check
      - sutazai-grafana-check

  # 4. Hardware Resource Optimizer - Dynamic resource management
  hardware-resource-optimizer:
    build:
      context: ./agents/hardware-optimizer
      dockerfile: Dockerfile
    container_name: sutazai-hardware-optimizer
    restart: unless-stopped
    environment:
      - MAX_MEMORY_MB=8192
      - CPU_THRESHOLD=80
      - MEMORY_THRESHOLD=85
      - OPTIMIZATION_INTERVAL=60
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - ./logs/optimizer:/logs
    networks:
      - sutazai-network
    user: root  # Fix for Docker socket permissions
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M  # Reduced from 512M
        reservations:
          cpus: '0.25'
          memory: 192M  # Reduced from 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8523/health"]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 60s

  # 5. Context Optimization Engineer - Token and context management
  context-optimization-engineer:
    build:
      context: ./agents/context-optimizer
      dockerfile: Dockerfile
    container_name: sutazai-context-optimizer
    restart: unless-stopped
    environment:
      - OPENAI_API_BASE=http://sutazai-litellm:4000
      - OPENAI_API_KEY=local
      - MAX_CONTEXT_LENGTH=4096
      - OPTIMIZATION_LEVEL=aggressive
    volumes:
      - ./config/context-engineering:/config
      - ./cache/context:/cache
      - ./logs/context:/logs
    networks:
      - sutazai-network
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8524/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Health check services to ensure dependencies are ready
  sutazai-ollama-check:
    image: curlimages/curl:latest
    container_name: sutazai-ollama-health-check
    command: >
      sh -c "
      echo 'Waiting for Ollama to be ready...' &&
      until curl -f http://sutazai-ollama:11434/api/tags > /dev/null 2>&1; do
        echo 'Ollama not ready, waiting 5 seconds...'
        sleep 5
      done &&
      echo 'Ollama is ready!'
      "
    networks:
      - sutazai-network
    restart: "no"

  sutazai-postgres-check:
    image: postgres:16.3-alpine
    container_name: sutazai-postgres-health-check
    command: >
      sh -c "
      echo 'Waiting for PostgreSQL to be ready...' &&
      until pg_isready -h sutazai-postgres -p 5432 -U sutazai > /dev/null 2>&1; do
        echo 'PostgreSQL not ready, waiting 5 seconds...'
        sleep 5
      done &&
      echo 'PostgreSQL is ready!'
      "
    networks:
      - sutazai-network
    restart: "no"

  sutazai-prometheus-check:
    image: curlimages/curl:latest
    container_name: sutazai-prometheus-health-check
    command: >
      sh -c "
      echo 'Waiting for Prometheus to be ready...' &&
      until curl -f http://sutazai-prometheus:9090/-/healthy > /dev/null 2>&1; do
        echo 'Prometheus not ready, waiting 5 seconds...'
        sleep 5
      done &&
      echo 'Prometheus is ready!'
      "
    networks:
      - sutazai-network
    restart: "no"

  sutazai-grafana-check:
    image: curlimages/curl:latest
    container_name: sutazai-grafana-health-check
    command: >
      sh -c "
      echo 'Waiting for Grafana to be ready...' &&
      until curl -f http://sutazai-grafana:3000/api/health > /dev/null 2>&1; do
        echo 'Grafana not ready, waiting 5 seconds...'
        sleep 5
      done &&
      echo 'Grafana is ready!'
      "
    networks:
      - sutazai-network
    restart: "no"

  # Monitoring exporter for Tier 1 agents
  tier1-exporter:
    image: prom/node-exporter:latest
    container_name: sutazai-tier1-exporter
    restart: unless-stopped
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    networks:
      - sutazai-network
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 64M