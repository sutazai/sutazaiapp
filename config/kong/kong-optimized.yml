_format_version: "3.0"
_transform: true

# Optimized Kong configuration for minimal memory and I/O usage

services:
  # Core backend service (most critical - route directly)
  - name: backend
    url: http://sutazai-backend:8000
    connect_timeout: 5000
    write_timeout: 60000
    read_timeout: 60000
    retries: 2
    routes:
      - name: backend-api
        paths: ["/api", "/health", "/docs", "/redoc", "/metrics"]
        strip_path: false
        request_buffering: false
        response_buffering: false

  # Frontend UI service
  - name: frontend
    url: http://sutazai-frontend:8501
    connect_timeout: 5000
    write_timeout: 60000
    read_timeout: 60000
    retries: 1
    routes:
      - name: frontend-ui
        paths: ["/app", "/"]
        strip_path: true
        request_buffering: false
        response_buffering: false

  # Ollama LLM service (high timeout for LLM ops)
  - name: ollama
    url: http://sutazai-ollama:11434
    connect_timeout: 5000
    write_timeout: 120000
    read_timeout: 120000
    retries: 1
    routes:
      - name: ollama-api
        paths: ["/ollama"]
        strip_path: true
        request_buffering: false
        response_buffering: false

# Global plugins for minimal overhead
plugins:
  # Lightweight CORS configuration
  - name: cors
    config:
      origins: ["*"]
      methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"]
      headers: ["Accept", "Authorization", "Content-Type", "X-Requested-With"]
      exposed_headers: ["X-Auth-Token"]
      credentials: true
      max_age: 3600
      preflight_continue: false

  # Request size limiting to prevent memory issues
  - name: request-size-limiting
    config:
      allowed_payload_size: 8  # 8MB max
      size_unit: megabytes
      require_content_length: false

  # Response rate limiting to prevent I/O spikes
  - name: response-ratelimiting
    config:
      limits:
        small:
          - 100 per second
        medium:
          - 50 per second
        large:
          - 10 per second
      policy: local
      fault_tolerant: true

  # Disable unnecessary logging to reduce I/O
  - name: file-log
    enabled: false

  # Disable request/response transformers (high memory usage)
  - name: request-transformer
    enabled: false
  
  - name: response-transformer
    enabled: false

# Upstreams with optimized connection pooling
upstreams:
  - name: backend-upstream
    algorithm: round-robin
    targets:
      - target: sutazai-backend:8000
        weight: 100
    healthchecks:
      active:
        enabled: true
        type: http
        http_path: /health
        interval: 30
        timeout: 5
        healthy:
          successes: 1
          http_statuses: [200, 301, 302, 303, 304]
        unhealthy:
          http_failures: 3
          timeouts: 3
      passive:
        enabled: true
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 5