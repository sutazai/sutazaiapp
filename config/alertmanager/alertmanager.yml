# AlertManager Configuration for Sutazai Platform
# Production-ready alert routing and notification management

global:
  resolve_timeout: 5m
  # Webhook URL for external notifications (Slack, Teams, etc.)
  # slack_api_url: 'https://hooks.slack.com/services/YOUR/WEBHOOK/URL'
  # pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

# Alert routing configuration
route:
  # Default receiver for all alerts
  receiver: 'default'
  
  # Group alerts by these labels
  group_by: ['alertname', 'cluster', 'service']
  
  # How long to wait before sending initial notification
  group_wait: 10s
  
  # How long to wait before sending notification about new alerts added to group
  group_interval: 10s
  
  # How long to wait before sending notification about resolved alerts
  repeat_interval: 12h
  
  # Sub-routes for specific alert types
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: 'critical'
      group_wait: 0s
      repeat_interval: 5m
      continue: true
    
    # Warning alerts - batch and notify
    - match:
        severity: warning
      receiver: 'warning'
      group_wait: 30s
      repeat_interval: 30m
    
    # Database alerts
    - match:
        category: database
      receiver: 'database'
      group_wait: 15s
      repeat_interval: 15m
    
    # AI agent alerts
    - match:
        category: agent
      receiver: 'agents'
      group_wait: 20s
      repeat_interval: 20m

# Alert suppression rules
inhibit_rules:
  # Suppress warning if critical alert is firing for same service
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service', 'instance']
  
  # Suppress instance down if entire cluster is down
  - source_match:
      alertname: 'ClusterDown'
    target_match:
      alertname: 'InstanceDown'
    equal: ['cluster']

# Notification receivers
receivers:
  # Default receiver - console logging
  - name: 'default'
    webhook_configs:
      - url: 'http://sutazai-backend:10200/api/v1/monitoring/alerts'
        send_resolved: true
        http_config:
          bearer_token: 'sutazai_alertmanager_webhook_token'
  
  # Critical alerts - multiple channels
  - name: 'critical'
    webhook_configs:
      - url: 'http://sutazai-backend:10200/api/v1/monitoring/alerts/critical'
        send_resolved: true
        http_config:
          bearer_token: 'sutazai_alertmanager_webhook_token'
    # Uncomment to enable Slack notifications
    # slack_configs:
    #   - channel: '#alerts-critical'
    #     title: 'CRITICAL: {{ .GroupLabels.alertname }}'
    #     text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
    #     send_resolved: true
    # Uncomment to enable PagerDuty
    # pagerduty_configs:
    #   - service_key: 'YOUR_PAGERDUTY_SERVICE_KEY'
    #     description: '{{ .GroupLabels.alertname }}'
  
  # Warning alerts
  - name: 'warning'
    webhook_configs:
      - url: 'http://sutazai-backend:10200/api/v1/monitoring/alerts/warning'
        send_resolved: true
        http_config:
          bearer_token: 'sutazai_alertmanager_webhook_token'
  
  # Database alerts
  - name: 'database'
    webhook_configs:
      - url: 'http://sutazai-backend:10200/api/v1/monitoring/alerts/database'
        send_resolved: true
        http_config:
          bearer_token: 'sutazai_alertmanager_webhook_token'
  
  # Agent alerts
  - name: 'agents'
    webhook_configs:
      - url: 'http://sutazai-backend:10200/api/v1/monitoring/alerts/agents'
        send_resolved: true
        http_config:
          bearer_token: 'sutazai_alertmanager_webhook_token'

# Time intervals for muting alerts (maintenance windows)
time_intervals:
  - name: 'business_hours'
    time_intervals:
      - times:
        - start_time: '09:00'
          end_time: '17:00'
        weekdays: ['monday:friday']
  
  - name: 'off_hours'
    time_intervals:
      - times:
        - start_time: '00:00'
          end_time: '09:00'
        - start_time: '17:00'
          end_time: '23:59'
      - weekdays: ['saturday', 'sunday']

# Mute rules (optional - uncomment to use)
# mute_time_intervals:
#   - name: 'maintenance_window'
#     time_intervals:
#       - times:
#         - start_time: '02:00'
#           end_time: '04:00'
#       weekdays: ['sunday']
