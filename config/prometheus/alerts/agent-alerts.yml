groups:
  - name: agent_alerts
    interval: 30s
    rules:
      # High error rate alert
      - alert: AgentHighErrorRate
        expr: |
          (
            sum(rate(agent_error_total[5m])) by (agent)
            /
            sum(rate(agent_request_total[5m])) by (agent)
          ) > 0.05
        for: 2m
        labels:
          severity: warning
          component: agents
        annotations:
          summary: "High error rate for agent {{ $labels.agent }}"
          description: "Agent {{ $labels.agent }} has error rate of {{ $value | humanizePercentage }} (threshold: 5%)"

      # High latency alert
      - alert: AgentHighLatency
        expr: |
          histogram_quantile(0.95, 
            sum(rate(agent_processing_duration_seconds_bucket[5m])) by (agent, le)
          ) > 0.3
        for: 2m
        labels:
          severity: warning
          component: agents
        annotations:
          summary: "High latency for agent {{ $labels.agent }}"
          description: "Agent {{ $labels.agent }} p95 latency is {{ $value | humanizeDuration }} (threshold: 300ms)"

      # Agent down alert
      - alert: AgentDown
        expr: up{job="agents"} == 0
        for: 1m
        labels:
          severity: critical
          component: agents
        annotations:
          summary: "Agent {{ $labels.instance }} is down"
          description: "Agent {{ $labels.instance }} has been down for more than 1 minute"

      # Agent unhealthy alert
      - alert: AgentUnhealthy
        expr: agent_health_status == 0
        for: 2m
        labels:
          severity: warning
          component: agents
        annotations:
          summary: "Agent {{ $labels.agent }} is unhealthy"
          description: "Agent {{ $labels.agent }} has been reporting unhealthy status for more than 2 minutes"

      # High queue latency alert
      - alert: AgentHighQueueLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(agent_queue_latency_seconds_bucket[5m])) by (agent, le)
          ) > 1
        for: 2m
        labels:
          severity: warning
          component: agents
        annotations:
          summary: "High queue latency for agent {{ $labels.agent }}"
          description: "Agent {{ $labels.agent }} queue latency p95 is {{ $value | humanizeDuration }} (threshold: 1s)"

      # High active requests alert
      - alert: AgentHighActiveRequests
        expr: agent_active_requests > 100
        for: 5m
        labels:
          severity: warning
          component: agents
        annotations:
          summary: "High active requests for agent {{ $labels.agent }}"
          description: "Agent {{ $labels.agent }} has {{ $value }} active requests (threshold: 100)"