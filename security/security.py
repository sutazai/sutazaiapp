"""SecurityutilitiesfortheSutazAIapplication,includingauthenticationandauthorization."""#Standardlibraryimportsfromdatetimeimportdatetime,timedeltafromtypingimportOptional#Third-partyimportsfromjoseimportJWTError,jwtfrompasslib.contextimportCryptContextfromfastapiimportDepends,HTTPException,statusfromfastapi.securityimportOAuth2PasswordBearerfromsqlalchemy.ormimportSessionfromdatabaseimportget_db_sessionfrommodelsimportUserfromschemasimportTokenDatafromconfigimportsettingspwd_context=CryptContext(schemes=["bcrypt"],deprecated="auto")oauth2_scheme=OAuth2PasswordBearer(tokenUrl="token")defverify_password(plain_password:str,hashed_password:str)->bool:"""Verifyaplainpasswordagainstahashedpassword."""returnpwd_context.verify(plain_password,hashed_password)defget_password_hash(password:str)->str:"""Hashapasswordforstorage."""returnpwd_context.hash(password)defcreate_access_token(data:dict,expires_delta:Optional[timedelta]=None)->str:"""CreateaJWTaccesstoken."""to_encode=data.copy()ifexpires_delta:expire=datetime.utcnow()+expires_deltaelse:expire=datetime.utcnow()+timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)to_encode.update({"exp":expire})encoded_jwt=jwt.encode(to_encode,settings.SECRET_KEY,algorithm=settings.ALGORITHM)returnencoded_jwtdefcreate_refresh_token(data:dict)->str:"""CreateaJWTrefreshtoken."""to_encode=data.copy()expire=datetime.utcnow()+timedelta(days=settings.REFRESH_TOKEN_EXPIRE_DAYS)to_encode.update({"exp":expire,"refresh":True})encoded_jwt=jwt.encode(to_encode,settings.SECRET_KEY,algorithm=settings.ALGORITHM)returnencoded_jwtasyncdefget_current_user(token:str=Depends(oauth2_scheme),db:Session=Depends(get_db_session))->User:"""Getthecurrentuserfromthetoken."""credentials_exception=HTTPException(status_code=status.HTTP_401_UNAUTHORIZED,detail="Couldnotvalidatecredentials",headers={"WWW-Authenticate":"Bearer"},)try:payload=jwt.decode(token,settings.SECRET_KEY,algorithms=[settings.ALGORITHM])email:str=payload.get("sub")ifemailisNone:raisecredentials_exceptiontoken_data=TokenData(email=email)exceptJWTErrorasexc:raisecredentials_exceptionfromexcuser=db.query(User).filter(User.email==token_data.email).first()ifuserisNone:raisecredentials_exceptionreturnuserasyncdefget_current_active_user(current_user:User=Depends(get_current_user))->User:"""Ensurethecurrentuserisactive."""ifnotcurrent_user.is_active:raiseHTTPException(status_code=400,detail="Inactiveuser")returncurrent_userasyncdefget_current_superuser(current_user:User=Depends(get_current_user))->User:"""Ensurethecurrentuserisasuperuser."""ifnotcurrent_user.is_superuser:raiseHTTPException(status_code=status.HTTP_403_FORBIDDEN,detail="Notenoughprivileges")returncurrent_user