# High-Availability Ollama Cluster Configuration
# Designed to handle 174+ concurrent consumers with load balancing

version: '3.8'

x-ollama-common: &ollama-common
  image: ollama/ollama:latest
  restart: unless-stopped
  volumes:
    - /opt/sutazaiapp/CLAUDE.md:/app/CLAUDE.md:ro
    - /opt/sutazaiapp/config/ollama.yaml:/app/config/ollama.yaml:ro
  environment:
    OLLAMA_API_KEY: local
    OLLAMA_HOST: 0.0.0.0
    OLLAMA_ORIGINS: '*'
    OLLAMA_NUM_PARALLEL: 25           # Distribute load across instances
    OLLAMA_NUM_THREADS: 4             # Balanced thread allocation
    OLLAMA_MAX_LOADED_MODELS: 2       # Allow multiple models per instance
    OLLAMA_KEEP_ALIVE: 10m
    OLLAMA_MODELS: /root/.ollama/models
    OLLAMA_DEBUG: false
    OLLAMA_FLASH_ATTENTION: 1
    OLLAMA_RUNNERS_DIR: /tmp
    OLLAMA_TMPDIR: /tmp
    CLAUDE_RULES_PATH: /app/CLAUDE.md
    ENFORCE_CLAUDE_RULES: 'true'
  deploy:
    resources:
      limits:
        cpus: '3'
        memory: 6G
      reservations:
        cpus: '1'
        memory: 2G
  networks:
    - sutazai-network
  healthcheck:
    test:
      - CMD-SHELL
      - ollama list > /dev/null || exit 1
    interval: 30s
    timeout: 10s
    retries: 5
    start_period: 60s

services:
  # Primary Ollama instance
  ollama-primary:
    <<: *ollama-common
    container_name: sutazai-ollama-primary
    ports:
      - "10104:11434"
    volumes:
      - ollama_primary_data:/root/.ollama
      - models_data:/models
      - /opt/sutazaiapp/CLAUDE.md:/app/CLAUDE.md:ro
      - /opt/sutazaiapp/config/ollama.yaml:/app/config/ollama.yaml:ro
    environment:
      <<: *ollama-common
      OLLAMA_BASE_URL: http://ollama-primary:11434
      INSTANCE_ID: primary
      INSTANCE_ROLE: primary

  # Secondary Ollama instance
  ollama-secondary:
    <<: *ollama-common
    container_name: sutazai-ollama-secondary
    ports:
      - "10105:11434"
    volumes:
      - ollama_secondary_data:/root/.ollama
      - models_data:/models:ro  # Shared model storage
      - /opt/sutazaiapp/CLAUDE.md:/app/CLAUDE.md:ro
      - /opt/sutazaiapp/config/ollama.yaml:/app/config/ollama.yaml:ro
    environment:
      <<: *ollama-common
      OLLAMA_BASE_URL: http://ollama-secondary:11434
      INSTANCE_ID: secondary
      INSTANCE_ROLE: replica
    depends_on:
      - ollama-primary

  # Tertiary Ollama instance for peak load
  ollama-tertiary:
    <<: *ollama-common
    container_name: sutazai-ollama-tertiary
    ports:
      - "10106:11434"
    volumes:
      - ollama_tertiary_data:/root/.ollama
      - models_data:/models:ro  # Shared model storage
      - /opt/sutazaiapp/CLAUDE.md:/app/CLAUDE.md:ro
      - /opt/sutazaiapp/config/ollama.yaml:/app/config/ollama.yaml:ro
    environment:
      <<: *ollama-common
      OLLAMA_BASE_URL: http://ollama-tertiary:11434
      INSTANCE_ID: tertiary
      INSTANCE_ROLE: replica
    depends_on:
      - ollama-primary

  # Load balancer for Ollama cluster
  ollama-loadbalancer:
    image: nginx:alpine
    container_name: sutazai-ollama-lb
    restart: unless-stopped
    ports:
      - "10107:80"
    volumes:
      - ./config/nginx/ollama-lb.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - ollama-primary
      - ollama-secondary
      - ollama-tertiary
    networks:
      - sutazai-network
    healthcheck:
      test:
        - CMD
        - wget
        - --no-verbose
        - --tries=1
        - --spider
        - http://localhost/health
      interval: 30s
      timeout: 10s
      retries: 3

  # Ollama cluster monitor
  ollama-monitor:
    build:
      context: ./docker/ollama-monitor
      dockerfile: Dockerfile
    container_name: sutazai-ollama-monitor
    restart: unless-stopped
    ports:
      - "10108:8080"
    environment:
      MONITOR_TARGETS: "ollama-primary:11434,ollama-secondary:11434,ollama-tertiary:11434"
      CHECK_INTERVAL: 15
      ALERT_THRESHOLD_CPU: 85
      ALERT_THRESHOLD_MEMORY: 90
      ALERT_THRESHOLD_QUEUE: 20
    volumes:
      - ./logs:/app/logs
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - ollama-primary
      - ollama-secondary
      - ollama-tertiary
    networks:
      - sutazai-network

volumes:
  ollama_primary_data:
  ollama_secondary_data:
  ollama_tertiary_data:
  models_data:

networks:
  sutazai-network:
    external: true