# SutazAI Knowledge Graph Builder Docker Compose Configuration

version: '3.8'

services:
  # Knowledge Graph Builder Service
  knowledge-graph-builder:
    container_name: sutazai-knowledge-graph-builder
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - AGENT_NAME=knowledge-graph-builder
      - AGENT_TYPE=knowledge-graph-builder
      - LOG_LEVEL=INFO
      - NEO4J_URI=bolt://sutazai-neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=sutazai123
      - PYTHONUNBUFFERED=1
      - HEALTH_PORT=8048
    volumes:
      - knowledge_graph_data:/data
      - knowledge_graph_logs:/logs
      - knowledge_graph_config:/app/config
      - knowledge_graph_exports:/data/exports
      # Mount source files for analysis
      - /opt/sutazaiapp/CLAUDE.md:/data/sources/CLAUDE.md:ro
      - /opt/sutazaiapp/docker-compose.complete-agents.yml:/data/sources/docker-compose.complete-agents.yml:ro
      - /opt/sutazaiapp/docker-compose.agents-simple.yml:/data/sources/docker-compose.agents-simple.yml:ro
    ports:
      - "8048:8048"
    networks:
      - sutazai-network
      - kg-network
    depends_on:
      - neo4j
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8048/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Neo4j Graph Database
  neo4j:
    image: neo4j:5.15-community
    container_name: sutazai-neo4j
    environment:
      - NEO4J_AUTH=neo4j/sutazai123
      - NEO4J_server_memory_heap_max__size=2G
      - NEO4J_server_memory_pagecache_size=1G
      - NEO4J_server_default__listen__address=0.0.0.0
      - NEO4J_server_bolt_listen__address=0.0.0.0:7687
      - NEO4J_server_http_listen__address=0.0.0.0:7474
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_conf:/conf
      - neo4j_plugins:/plugins
    ports:
      - "7474:7474"  # HTTP interface
      - "7687:7687"  # Bolt protocol
    networks:
      - kg-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "sutazai123", "RETURN 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Knowledge Graph Web UI (Optional)
  kg-web-ui:
    container_name: sutazai-kg-web-ui
    build:
      context: .
      dockerfile: Dockerfile.webui
    environment:
      - KG_API_URL=http://knowledge-graph-builder:8048
      - NEO4J_BROWSER_URL=http://sutazai-neo4j:7474
    volumes:
      - kg_web_static:/app/static
    ports:
      - "8049:8080"
    networks:
      - sutazai-network
      - kg-network
    depends_on:
      - knowledge-graph-builder
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Redis for caching (Optional)
  redis:
    image: redis:7-alpine
    container_name: sutazai-kg-redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - kg-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 3s
      retries: 3

# Networks
networks:
  sutazai-network:
    name: sutazaiapp_sutazai-network
    external: true
  kg-network:
    driver: bridge
    name: sutazai-kg-network

# Volumes
volumes:
  # Knowledge Graph data
  knowledge_graph_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/sutazaiapp/data/knowledge_graph
  
  knowledge_graph_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/sutazaiapp/logs/knowledge_graph
  
  knowledge_graph_config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/sutazaiapp/config/knowledge_graph
  
  knowledge_graph_exports:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/sutazaiapp/exports/knowledge_graph
  
  # Neo4j data
  neo4j_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/sutazaiapp/data/neo4j
  
  neo4j_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/sutazaiapp/logs/neo4j
  
  neo4j_conf:
    driver: local
  
  neo4j_plugins:
    driver: local
  
  # Web UI static files
  kg_web_static:
    driver: local
  
  # Redis data
  redis_data:
    driver: local