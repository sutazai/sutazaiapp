# SutazAI Alert Rules
# Comprehensive alerting for continuous monitoring

groups:
  # Performance Alerts
  - name: performance_alerts
    interval: 30s
    rules:
      - alert: HighResponseTime
        expr: http_request_duration_seconds{quantile="0.95"} > 0.5
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "High response time on {{ $labels.service }}"
          description: "95th percentile response time is {{ $value }}s (threshold: 0.5s)"
          
      - alert: CriticalResponseTime
        expr: http_request_duration_seconds{quantile="0.99"} > 1
        for: 2m
        labels:
          severity: critical
          category: performance
        annotations:
          summary: "Critical response time on {{ $labels.service }}"
          description: "99th percentile response time is {{ $value }}s (threshold: 1s)"
          
      - alert: LowThroughput
        expr: rate(http_requests_total[5m]) < 10
        for: 10m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "Low request throughput"
          description: "Request rate is {{ $value }} req/s (expected: >10)"

  # Hardware Resource Alerts
  - name: hardware_alerts
    interval: 15s
    rules:
      - alert: HighCPUUsage
        expr: |
          (100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 80
        for: 5m
        labels:
          severity: warning
          category: hardware
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ $value }}% (threshold: 80%)"
          
      - alert: CriticalCPUUsage
        expr: |
          (100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 95
        for: 2m
        labels:
          severity: critical
          category: hardware
        annotations:
          summary: "Critical CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ $value }}% (threshold: 95%)"
          
      - alert: HighMemoryUsage
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          category: hardware
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is {{ $value }}% (threshold: 85%)"
          
      - alert: DiskSpaceLow
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 15
        for: 5m
        labels:
          severity: warning
          category: hardware
        annotations:
          summary: "Low disk space on {{ $labels.instance }}"
          description: "Available disk space is {{ $value }}% (threshold: 15%)"
          
      - alert: HighNetworkTraffic
        expr: |
          rate(node_network_receive_bytes_total[5m]) > 100000000
        for: 5m
        labels:
          severity: warning
          category: hardware
        annotations:
          summary: "High network traffic on {{ $labels.instance }}"
          description: "Network receive rate is {{ $value | humanize }}B/s"

  # Service Health Alerts
  - name: service_health_alerts
    interval: 30s
    rules:
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "Service {{ $labels.service }} is down"
          description: "{{ $labels.service }} on {{ $labels.instance }} has been down for more than 1 minute"
          
      - alert: HighErrorRate
        expr: |
          rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          category: errors
        annotations:
          summary: "High error rate on {{ $labels.service }}"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
          
      - alert: CriticalErrorRate
        expr: |
          rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
          category: errors
        annotations:
          summary: "Critical error rate on {{ $labels.service }}"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 10%)"

  # Database Alerts
  - name: database_alerts
    interval: 30s
    rules:
      - alert: DatabaseConnectionPoolExhausted
        expr: |
          pg_stat_database_numbackends / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Database connection pool nearly exhausted"
          description: "{{ $value | humanizePercentage }} of connections used"
          
      - alert: DatabaseSlowQueries
        expr: |
          rate(pg_stat_statements_mean_exec_time_seconds[5m]) > 1
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Slow database queries detected"
          description: "Average query time is {{ $value }}s"
          
      - alert: RedisHighMemory
        expr: |
          redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Redis memory usage high"
          description: "Redis using {{ $value | humanizePercentage }} of max memory"

  # AI/ML Service Alerts
  - name: ai_ml_alerts
    interval: 30s
    rules:
      - alert: ModelInferenceLatencyHigh
        expr: |
          histogram_quantile(0.95, rate(model_inference_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
          category: ai_ml
        annotations:
          summary: "High model inference latency"
          description: "95th percentile inference time is {{ $value }}s"
          
      - alert: GPUUtilizationLow
        expr: |
          nvidia_gpu_utilization < 30 and nvidia_gpu_utilization > 0
        for: 15m
        labels:
          severity: info
          category: ai_ml
        annotations:
          summary: "GPU underutilized"
          description: "GPU utilization is {{ $value }}%"
          
      - alert: ModelLoadFailure
        expr: |
          increase(model_load_failures_total[5m]) > 0
        labels:
          severity: critical
          category: ai_ml
        annotations:
          summary: "Model load failures detected"
          description: "{{ $value }} model load failures in the last 5 minutes"

  # Container Alerts
  - name: container_alerts
    interval: 30s
    rules:
      - alert: ContainerRestarting
        expr: |
          rate(container_last_seen[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          category: container
        annotations:
          summary: "Container {{ $labels.container_name }} is restarting frequently"
          description: "Container has restarted {{ $value }} times in 5 minutes"
          
      - alert: ContainerHighCPU
        expr: |
          rate(container_cpu_usage_seconds_total[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          category: container
        annotations:
          summary: "High CPU usage in container {{ $labels.container_name }}"
          description: "Container CPU usage is {{ $value | humanizePercentage }}"
          
      - alert: ContainerOOMKilled
        expr: |
          increase(container_oom_events_total[5m]) > 0
        labels:
          severity: critical
          category: container
        annotations:
          summary: "Container {{ $labels.container_name }} OOM killed"
          description: "Container was killed due to out of memory"

  # Deployment Alerts
  - name: deployment_alerts
    interval: 30s
    rules:
      - alert: DeploymentRollbackDetected
        expr: |
          increase(deployment_rollback_total[1h]) > 0
        labels:
          severity: warning
          category: deployment
        annotations:
          summary: "Deployment rollback detected"
          description: "{{ $value }} rollbacks in the last hour"
          
      - alert: CanaryDeploymentHighErrors
        expr: |
          rate(http_requests_total{deployment="canary",status=~"5.."}[5m]) > 0.02
        for: 2m
        labels:
          severity: critical
          category: deployment
        annotations:
          summary: "High error rate in canary deployment"
          description: "Canary error rate is {{ $value | humanizePercentage }}"
          
      - alert: BlueGreenSwitchFailure
        expr: |
          increase(blue_green_switch_failures_total[5m]) > 0
        labels:
          severity: critical
          category: deployment
        annotations:
          summary: "Blue-Green deployment switch failed"
          description: "Blue-Green switch failed {{ $value }} times"

  # Security Alerts
  - name: security_alerts
    interval: 30s
    rules:
      - alert: UnauthorizedAccessAttempts
        expr: |
          rate(http_requests_total{status="401"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "High rate of unauthorized access attempts"
          description: "{{ $value | humanize }} unauthorized attempts per second"
          
      - alert: SuspiciousTrafficPattern
        expr: |
          rate(http_requests_total[1m]) > 1000 and hour() >= 2 and hour() <= 5
        for: 5m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "Suspicious traffic pattern detected"
          description: "High traffic during off-hours: {{ $value | humanize }} req/s"
          
      - alert: SSLCertificateExpiringSoon
        expr: |
          probe_ssl_earliest_cert_expiry - time() < 7 * 24 * 3600
        for: 1h
        labels:
          severity: warning
          category: security
        annotations:
          summary: "SSL certificate expiring soon"
          description: "Certificate expires in {{ $value | humanizeDuration }}"

  # Business Metrics Alerts
  - name: business_alerts
    interval: 1m
    rules:
      - alert: LowUserEngagement
        expr: |
          rate(user_actions_total[1h]) < 100
        for: 30m
        labels:
          severity: info
          category: business
        annotations:
          summary: "Low user engagement detected"
          description: "User action rate is {{ $value | humanize }} per hour"
          
      - alert: HighAPIUsageCost
        expr: |
          sum(rate(api_calls_total[1h])) * 0.001 > 100
        for: 1h
        labels:
          severity: warning
          category: business
        annotations:
          summary: "High API usage cost"
          description: "Estimated hourly cost: ${{ $value | humanize }}"