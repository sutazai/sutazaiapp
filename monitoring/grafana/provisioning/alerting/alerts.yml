apiVersion: 1

groups:
  - name: SutazAI System Alerts
    folder: SutazAI
    interval: 1m
    rules:
      - uid: high_cpu_usage
        title: High CPU Usage
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: '100 - (avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)'
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          summary: CPU usage is above 85%
          description: "CPU usage is {{ $value }}%"
        labels:
          severity: warning
          component: system
        
      - uid: high_memory_usage
        title: High Memory Usage
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: '(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100'
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          summary: Memory usage is above 85%
          description: "Memory usage is {{ $value }}%"
        labels:
          severity: warning
          component: system
          
      - uid: high_disk_usage
        title: High Disk Usage
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: '(1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})) * 100'
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          summary: Disk usage is above 85%
          description: "Disk usage is {{ $value }}%"
        labels:
          severity: critical
          component: system
          
  - name: SutazAI Container Alerts
    folder: SutazAI
    interval: 1m
    rules:
      - uid: container_down
        title: Container Down
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'up{job=~"sutazai.*"} == 0'
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 2m
        annotations:
          summary: "Container {{ $labels.job }} is down"
          description: "Container {{ $labels.job }} has been down for more than 2 minutes"
        labels:
          severity: critical
          component: container
          
      - uid: container_restart
        title: Container Restarting
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'rate(container_restart_count{name=~"sutazai.*"}[5m]) > 0'
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          summary: "Container {{ $labels.name }} is restarting"
          description: "Container {{ $labels.name }} has restarted {{ $value }} times in the last 5 minutes"
        labels:
          severity: warning
          component: container
          
  - name: SutazAI API Alerts
    folder: SutazAI
    interval: 1m
    rules:
      - uid: high_api_latency
        title: High API Latency
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'histogram_quantile(0.95, sum(rate(fastapi_request_duration_seconds_bucket[5m])) by (le)) * 1000'
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          summary: API latency is high
          description: "95th percentile API latency is {{ $value }}ms"
        labels:
          severity: warning
          component: api
          
      - uid: high_error_rate
        title: High Error Rate
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'sum(rate(fastapi_requests_total{status=~"5.."}[5m])) / sum(rate(fastapi_requests_total[5m])) * 100'
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          summary: High API error rate
          description: "Error rate is {{ $value }}%"
        labels:
          severity: critical
          component: api
          
  - name: SutazAI Agent Alerts
    folder: SutazAI
    interval: 1m
    rules:
      - uid: agent_failure_rate
        title: High Agent Failure Rate
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: '(1 - (sum(rate(sutazai_agent_tasks_successful_total[5m])) / sum(rate(sutazai_agent_tasks_total[5m])))) * 100'
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          summary: Agent failure rate is high
          description: "Agent failure rate is {{ $value }}%"
        labels:
          severity: warning
          component: agents
          
      - uid: no_active_agents
        title: No Active Agents
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'sutazai_active_agents == 0'
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          summary: No active agents available
          description: "There are no active agents in the system"
        labels:
          severity: critical
          component: agents
          
  - name: SutazAI Model Alerts
    folder: SutazAI
    interval: 1m
    rules:
      - uid: high_model_inference_time
        title: High Model Inference Time
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'histogram_quantile(0.95, sum(rate(ollama_inference_duration_milliseconds_bucket[5m])) by (le))'
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          summary: Model inference time is high
          description: "95th percentile inference time is {{ $value }}ms"
        labels:
          severity: warning
          component: models
          
      - uid: gpu_memory_high
        title: GPU Memory Usage High
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'nvidia_smi_memory_used_bytes / nvidia_smi_memory_total_bytes * 100'
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          summary: GPU memory usage is high
          description: "GPU memory usage is {{ $value }}%"
        labels:
          severity: warning
          component: gpu

notification_policies:
  - receiver: slack-critical
    matchers:
      - severity = critical
  - receiver: slack-warnings
    matchers:
      - severity = warning
      
contact_points:
  - name: slack-critical
    slack_configs:
      - url: ${SLACK_WEBHOOK_CRITICAL}
        title: "SutazAI Critical Alert"
        text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        
  - name: slack-warnings
    slack_configs:
      - url: ${SLACK_WEBHOOK_WARNING}
        title: "SutazAI Warning"
        text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'