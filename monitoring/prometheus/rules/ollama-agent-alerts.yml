groups:
  - name: sutazai_ollama_agents
    rules:
      # High-severity alerts for system freeze prevention
      - alert: SystemFreezeRiskCritical
        expr: sutazai_freeze_risk_score > 90
        for: 1m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Critical system freeze risk detected"
          description: "System freeze risk score is {{ $value }}% which is above the critical threshold of 90%"
          runbook_url: "https://docs.sutazai.com/runbooks/system-freeze-prevention"

      - alert: SystemFreezeRiskHigh
        expr: sutazai_freeze_risk_score > 80
        for: 2m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High system freeze risk detected"
          description: "System freeze risk score is {{ $value }}% which is above the warning threshold of 80%"

      # System resource alerts
      - alert: SystemMemoryUsageHigh
        expr: sutazai_system_memory_usage_percent > 85
        for: 2m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High system memory usage"
          description: "System memory usage is {{ $value }}% which is above 85%"

      - alert: SystemMemoryUsageCritical
        expr: sutazai_system_memory_usage_percent > 95
        for: 30s
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Critical system memory usage"
          description: "System memory usage is {{ $value }}% which is above 95%"

      - alert: SystemCPUUsageHigh
        expr: sutazai_system_cpu_usage_percent > 90
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High system CPU usage"
          description: "System CPU usage is {{ $value }}% which is above 90%"

      # Ollama-specific alerts
      - alert: OllamaQueueDepthHigh
        expr: sutazai_ollama_queue_depth > 50
        for: 2m
        labels:
          severity: warning
          component: ollama
        annotations:
          summary: "Ollama queue depth is high"
          description: "Ollama queue depth is {{ $value }} requests, indicating potential bottleneck"

      - alert: OllamaQueueDepthCritical
        expr: sutazai_ollama_queue_depth > 100
        for: 1m
        labels:
          severity: critical
          component: ollama
        annotations:
          summary: "Ollama queue depth is critical"
          description: "Ollama queue depth is {{ $value }} requests, system may freeze"

      - alert: OllamaResponseTimeSlow
        expr: histogram_quantile(0.95, rate(sutazai_ollama_response_time_seconds_bucket[5m])) > 30
        for: 3m
        labels:
          severity: warning
          component: ollama
        annotations:
          summary: "Ollama response times are slow"
          description: "95th percentile response time is {{ $value }} seconds for model {{ $labels.model }}"

      - alert: OllamaResponseTimeCritical
        expr: histogram_quantile(0.95, rate(sutazai_ollama_response_time_seconds_bucket[5m])) > 60
        for: 1m
        labels:
          severity: critical
          component: ollama
        annotations:
          summary: "Ollama response times are critically slow"
          description: "95th percentile response time is {{ $value }} seconds for model {{ $labels.model }}"

      - alert: OllamaHighFailureRate
        expr: rate(sutazai_ollama_requests_total{status="failure"}[5m]) / rate(sutazai_ollama_requests_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          component: ollama
        annotations:
          summary: "High Ollama failure rate"
          description: "Ollama failure rate is {{ $value | humanizePercentage }} for model {{ $labels.model }}"

      - alert: OllamaCriticalFailureRate
        expr: rate(sutazai_ollama_requests_total{status="failure"}[5m]) / rate(sutazai_ollama_requests_total[5m]) > 0.25
        for: 1m
        labels:
          severity: critical
          component: ollama
        annotations:
          summary: "Critical Ollama failure rate"
          description: "Ollama failure rate is {{ $value | humanizePercentage }} for model {{ $labels.model }}"

      # Agent-specific alerts
      - alert: AgentDown
        expr: sutazai_agent_status == 0
        for: 2m
        labels:
          severity: warning
          component: agent
        annotations:
          summary: "Agent is down"
          description: "Agent {{ $labels.agent_name }} using model {{ $labels.model }} is not active"

      - alert: AgentHighMemoryUsage
        expr: sutazai_agent_memory_usage_mb > 2048
        for: 5m
        labels:
          severity: warning
          component: agent
        annotations:
          summary: "Agent using high memory"
          description: "Agent {{ $labels.agent_name }} is using {{ $value }}MB of memory"

      - alert: AgentCriticalMemoryUsage
        expr: sutazai_agent_memory_usage_mb > 4096
        for: 2m
        labels:
          severity: critical
          component: agent
        annotations:
          summary: "Agent using critical memory"
          description: "Agent {{ $labels.agent_name }} is using {{ $value }}MB of memory"

      - alert: AgentHighCPUUsage
        expr: sutazai_agent_cpu_usage_percent > 80
        for: 10m
        labels:
          severity: warning
          component: agent
        annotations:
          summary: "Agent using high CPU"
          description: "Agent {{ $labels.agent_name }} is using {{ $value }}% CPU"

      - alert: AgentTaskFailureRateHigh
        expr: rate(sutazai_agent_tasks_failed_total[5m]) / (rate(sutazai_agent_tasks_processed_total[5m]) + rate(sutazai_agent_tasks_failed_total[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
          component: agent
        annotations:
          summary: "Agent has high task failure rate"
          description: "Agent {{ $labels.agent_name }} has a task failure rate of {{ $value | humanizePercentage }}"

      - alert: CircuitBreakerTrippingFrequently
        expr: rate(sutazai_circuit_breaker_trips_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          component: circuit_breaker
        annotations:
          summary: "Circuit breaker tripping frequently"
          description: "Agent {{ $labels.agent_name }} circuit breaker is tripping at {{ $value }} trips per second"

      - alert: CircuitBreakerTrippingCritically
        expr: rate(sutazai_circuit_breaker_trips_total[5m]) > 0.5
        for: 1m
        labels:
          severity: critical
          component: circuit_breaker
        annotations:
          summary: "Circuit breaker tripping critically"
          description: "Agent {{ $labels.agent_name }} circuit breaker is tripping at {{ $value }} trips per second"

      # Agent processing performance
      - alert: AgentProcessingTimeSlow
        expr: histogram_quantile(0.95, rate(sutazai_agent_processing_time_seconds_bucket[5m])) > 300
        for: 5m
        labels:
          severity: warning
          component: agent
        annotations:
          summary: "Agent processing time is slow"
          description: "95th percentile processing time for agent {{ $labels.agent_name }} is {{ $value }} seconds"

      - alert: AgentProcessingTimeCritical
        expr: histogram_quantile(0.95, rate(sutazai_agent_processing_time_seconds_bucket[5m])) > 600
        for: 2m
        labels:
          severity: critical
          component: agent
        annotations:
          summary: "Agent processing time is critically slow"
          description: "95th percentile processing time for agent {{ $labels.agent_name }} is {{ $value }} seconds"

      # System connectivity alerts
      - alert: AgentStale
        expr: time() - sutazai_agent_last_heartbeat_timestamp > 300
        for: 1m
        labels:
          severity: warning
          component: agent
        annotations:
          summary: "Agent heartbeat is stale"
          description: "Agent {{ $labels.agent_name }} has not sent heartbeat for {{ $value }} seconds"

      - alert: AgentMissing
        expr: time() - sutazai_agent_last_heartbeat_timestamp > 600
        for: 1m
        labels:
          severity: critical
          component: agent
        annotations:
          summary: "Agent is missing"
          description: "Agent {{ $labels.agent_name }} has not sent heartbeat for {{ $value }} seconds"

      # Multi-agent coordination alerts
      - alert: TooFewActiveAgents
        expr: sum(sutazai_agent_status) < 10
        for: 3m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "Too few active agents"
          description: "Only {{ $value }} agents are currently active, expected at least 10"

      - alert: CriticallyFewActiveAgents
        expr: sum(sutazai_agent_status) < 5
        for: 1m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Critically few active agents"
          description: "Only {{ $value }} agents are currently active, system may be failing"

      - alert: NoActiveAgents
        expr: sum(sutazai_agent_status) == 0
        for: 30s
        labels:
          severity: critical
          component: system
        annotations:
          summary: "No active agents"
          description: "No agents are currently active, system is down"

  - name: sutazai_freeze_prevention
    rules:
      # Advanced freeze prevention rules
      - record: sutazai:queue_saturation_ratio
        expr: sutazai_ollama_queue_depth / 100  # Normalize to 0-1

      - record: sutazai:memory_pressure_ratio
        expr: sutazai_system_memory_usage_percent / 100

      - record: sutazai:cpu_pressure_ratio
        expr: sutazai_system_cpu_usage_percent / 100

      - record: sutazai:agent_failure_ratio
        expr: sum(rate(sutazai_agent_tasks_failed_total[5m])) / sum(rate(sutazai_agent_tasks_processed_total[5m]) + rate(sutazai_agent_tasks_failed_total[5m]))

      - record: sutazai:ollama_failure_ratio
        expr: sum(rate(sutazai_ollama_requests_total{status="failure"}[5m])) / sum(rate(sutazai_ollama_requests_total[5m]))

      - alert: FreezePreventionThresholdReached
        expr: |
          (
            sutazai:queue_saturation_ratio * 0.3 +
            sutazai:memory_pressure_ratio * 0.3 +
            sutazai:cpu_pressure_ratio * 0.2 +
            sutazai:agent_failure_ratio * 0.1 +
            sutazai:ollama_failure_ratio * 0.1
          ) > 0.8
        for: 1m
        labels:
          severity: critical
          component: freeze_prevention
        annotations:
          summary: "System freeze prevention threshold reached"
          description: "Combined system stress indicators suggest imminent freeze risk. Take immediate action."