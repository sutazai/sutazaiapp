<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hygiene System Memory Leak Monitor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1, h2 {
            color: #ff6b6b;
            text-align: center;
        }
        .alert {
            background-color: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .metric {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .metric.critical { color: #ff4444; }
        .metric.warning { color: #ffaa44; }
        .metric.ok { color: #44ff44; }
        .issue-list {
            background-color: #333;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .issue-item {
            padding: 8px;
            margin: 5px 0;
            background-color: #444;
            border-radius: 3px;
            border-left: 4px solid #ff6b6b;
        }
        .fix-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .fix-button:hover {
            background-color: #45a049;
        }
        .chart-container {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            height: 300px;
        }
        #memoryChart {
            width: 100%;
            height: 100%;
        }
        .log-viewer {
            background-color: #1a1a1a;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px;
        }
        .log-entry.error { color: #ff4444; }
        .log-entry.warning { color: #ffaa44; }
        .log-entry.info { color: #44aaff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® Hygiene System Memory Leak Monitor</h1>
        
        <div class="alert">
            <strong>CRITICAL:</strong> Memory leak detected in hygiene monitoring system. 
            WebSocket clients not being properly cleaned up. Stack overflow protections active.
        </div>

        <div class="grid">
            <div class="card">
                <h3>WebSocket Connections</h3>
                <div class="metric critical" id="wsConnections">Loading...</div>
                <p>Active connections (should be < 50)</p>
                <div class="issue-list">
                    <div class="issue-item">‚ùå No periodic cleanup of disconnected clients</div>
                    <div class="issue-item">‚ùå Clients accumulate in memory</div>
                </div>
            </div>

            <div class="card">
                <h3>Memory Usage</h3>
                <div class="metric warning" id="memoryUsage">Loading...</div>
                <p>Process memory (MB)</p>
                <div class="issue-list">
                    <div class="issue-item">‚ö†Ô∏è Growing at ~10MB/hour</div>
                    <div class="issue-item">‚ö†Ô∏è No memory limits enforced</div>
                </div>
            </div>

            <div class="card">
                <h3>Database Connections</h3>
                <div class="metric ok" id="dbConnections">Loading...</div>
                <p>Active PostgreSQL connections</p>
                <div class="issue-list">
                    <div class="issue-item">‚úì Pool limit: 10</div>
                    <div class="issue-item">‚ö†Ô∏è Idle connections detected</div>
                </div>
            </div>

            <div class="card">
                <h3>Stack Depth</h3>
                <div class="metric ok" id="stackDepth">Protected</div>
                <p>Max recursion depth: 20</p>
                <div class="issue-list">
                    <div class="issue-item">‚úì Circular reference detection</div>
                    <div class="issue-item">‚úì Safe JSON encoder implemented</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Memory Usage Trend</h2>
            <div class="chart-container">
                <canvas id="memoryChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h2>Detected Issues</h2>
            <div class="issue-list">
                <div class="issue-item">
                    <strong>1. WebSocket Memory Leak</strong>
                    <p>Location: /opt/sutazaiapp/monitoring/enhanced-hygiene-backend.py:125</p>
                    <p>Issue: WebSocket clients stored in set without cleanup mechanism</p>
                    <p>Impact: Memory grows with each connection</p>
                </div>
                <div class="issue-item">
                    <strong>2. File I/O Blocking</strong>
                    <p>Location: /opt/sutazaiapp/monitoring/enhanced-hygiene-backend.py:357-388</p>
                    <p>Issue: Synchronous file reading in async context</p>
                    <p>Impact: Thread blocking, performance degradation</p>
                </div>
                <div class="issue-item">
                    <strong>3. Unbounded Violation Storage</strong>
                    <p>Location: Database accumulates violations without cleanup</p>
                    <p>Issue: No retention policy or archival</p>
                    <p>Impact: Database growth, query performance degradation</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Quick Fixes</h2>
            <button class="fix-button" onclick="restartBackend()">Restart Backend</button>
            <button class="fix-button" onclick="clearWebSockets()">Clear WebSocket Clients</button>
            <button class="fix-button" onclick="runMemoryProfiler()">Run Memory Profiler</button>
            <button class="fix-button" onclick="applyPatch()">Apply Memory Leak Patch</button>
        </div>

        <div class="card">
            <h2>Live Logs</h2>
            <div class="log-viewer" id="logViewer">
                <div class="log-entry info">[INFO] Dashboard loaded</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Simulated data for demonstration
        let memoryData = [];
        let timeLabels = [];
        
        // Initialize chart
        const ctx = document.getElementById('memoryChart').getContext('2d');
        const memoryChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Memory Usage (MB)',
                    data: memoryData,
                    borderColor: '#ff6b6b',
                    backgroundColor: 'rgba(255, 107, 107, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#e0e0e0' },
                        grid: { color: '#444' }
                    },
                    x: {
                        ticks: { color: '#e0e0e0' },
                        grid: { color: '#444' }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: '#e0e0e0' }
                    }
                }
            }
        });

        // Update metrics
        async function updateMetrics() {
            try {
                // Simulated values for demonstration
                const wsCount = 45 + Math.floor(Math.random() * 20);
                const memory = 250 + Math.floor(Math.random() * 50);
                const dbConn = 5 + Math.floor(Math.random() * 3);
                
                document.getElementById('wsConnections').textContent = wsCount;
                document.getElementById('wsConnections').className = wsCount > 50 ? 'metric critical' : 'metric warning';
                
                document.getElementById('memoryUsage').textContent = memory + ' MB';
                document.getElementById('memoryUsage').className = memory > 300 ? 'metric critical' : 'metric warning';
                
                document.getElementById('dbConnections').textContent = dbConn + '/10';
                document.getElementById('dbConnections').className = dbConn > 8 ? 'metric warning' : 'metric ok';
                
                // Update chart
                const now = new Date();
                timeLabels.push(now.toLocaleTimeString());
                memoryData.push(memory);
                
                if (timeLabels.length > 20) {
                    timeLabels.shift();
                    memoryData.shift();
                }
                
                memoryChart.update();
                
                // Add log entry
                if (wsCount > 60) {
                    addLog('error', `[ERROR] WebSocket connections critical: ${wsCount}`);
                }
                
            } catch (error) {
                console.error('Error updating metrics:', error);
            }
        }

        function addLog(level, message) {
            const logViewer = document.getElementById('logViewer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${level}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logViewer.appendChild(entry);
            logViewer.scrollTop = logViewer.scrollHeight;
            
            // Keep only last 50 entries
            while (logViewer.children.length > 50) {
                logViewer.removeChild(logViewer.firstChild);
            }
        }

        // Button actions
        function restartBackend() {
            addLog('info', '[INFO] Restarting hygiene backend...');
            // In real implementation, would call API
            setTimeout(() => addLog('info', '[INFO] Backend restarted successfully'), 2000);
        }

        function clearWebSockets() {
            addLog('info', '[INFO] Clearing disconnected WebSocket clients...');
            setTimeout(() => addLog('info', '[INFO] Cleared 23 disconnected clients'), 1000);
        }

        function runMemoryProfiler() {
            addLog('info', '[INFO] Starting memory profiler...');
            addLog('info', '[INFO] Run: python /opt/sutazaiapp/scripts/profile-hygiene-memory.py');
        }

        function applyPatch() {
            addLog('warning', '[WARNING] Applying memory leak patch...');
            addLog('info', '[INFO] See /opt/sutazaiapp/monitoring/websocket-cleanup-patch.py');
        }

        // Start updating metrics
        updateMetrics();
        setInterval(updateMetrics, 5000);
        
        // Initial logs
        addLog('warning', '[WARNING] Memory leak detected in hygiene monitoring system');
        addLog('error', '[ERROR] WebSocket clients not being cleaned up properly');
        addLog('info', '[INFO] Stack overflow protections are active');
    </script>
</body>
</html>