#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Run format check
npm run format || exit 1

# Run linting
npm exec -- lint-staged --config ./path/to/lint-staged.config.js || exit 1

# Run security audit
npm run security || exit 1

# Check for outdated dependencies
npm run outdated || exit 1

# Validate AI models
if [ -f "ai_models/validate.sh" ]; then
  ./ai_models/validate.sh --strict --checkpoint latest || exit 1
fi

# Add AI-specific checks
npm run lint-ai -- --ai-safety-check || exit 1
npm run validate-prompts -- --threshold 0.9 || exit 1
git-secrets --scan  # Prevent secrets in AI configs

# Added build step
npm run build || { echo "Build failed"; exit 1; }

# Consolidated test execution
npm run test:ci || exit 1

# Add test coverage check
npm run test:coverage || {
  echo "Tests failed - commit rejected"
  exit 1
}

# Add vulnerability check
npm audit --audit-level=moderate

# Security scanning suite
echo "Running comprehensive security checks..."
npm run sec-check && \
docker run --rm -v $PWD:/app shiftleft/scan scan --build --fail \
bandit -r src/backend/ -x tests && \
trivy config --severity HIGH,CRITICAL . || exit 1

# Added lint-staged configuration
npx lint-staged --concurrent true --relative  # Parallel execution
npm run test:related  # Ensure tests are run for changed files

npm run lint && npm test
[ $? -ne 0 ] && exit 1 