version: '3.8'

services:
  consul:
    image: hashicorp/consul:latest
    container_name: sutazaiapp-consul
    command: agent -server -ui -node=server-1 -bootstrap-expect=1 -client=0.0.0.0
    ports:
      - "10006:8500"  # Consul UI and HTTP API
      - "8600:8600/udp"  # Consul DNS
    networks:
      - sutazaiapp_sutazai
    volumes:
      - consul_data:/consul/data
    environment:
      - CONSUL_BIND_INTERFACE=eth0
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  kong:
    image: kong:3.5
    container_name: sutazaiapp-kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: "/kong/declarative/kong.yml"
      KONG_PROXY_ACCESS_LOG: "/dev/stdout"
      KONG_ADMIN_ACCESS_LOG: "/dev/stdout"
      KONG_PROXY_ERROR_LOG: "/dev/stderr"
      KONG_ADMIN_ERROR_LOG: "/dev/stderr"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_PROXY_LISTEN: "0.0.0.0:8000"
    ports:
      - "10005:8000"  # Kong Proxy
      - "8001:8001"   # Kong Admin API
    networks:
      - sutazaiapp_sutazai
    volumes:
      - ./config/kong:/kong/declarative
    depends_on:
      consul:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: sutazaiapp-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: sutazai
      RABBITMQ_DEFAULT_PASS: sutazai_pass
      RABBITMQ_DEFAULT_VHOST: sutazai_vhost
    ports:
      - "10007:5672"   # AMQP port
      - "10008:15672"  # Management UI
    networks:
      - sutazaiapp_sutazai
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - rabbitmq_logs:/var/log/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_running"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

networks:
  sutazaiapp_sutazai:
    external: true

volumes:
  consul_data:
    driver: local
  rabbitmq_data:
    driver: local
  rabbitmq_logs:
    driver: local