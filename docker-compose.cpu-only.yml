# CPU-Only Docker Compose Override for Systems Without GPU
# Use with: docker compose -f docker-compose.yml -f docker-compose.cpu-only.yml up -d

services:
  # TabbyML Code Completion - Smart CPU-Only Mode (Alternative to custom build)
  tabbyml:
    image: tabbyml/tabby:latest
    entrypoint: ["/bin/bash", "-c"]
    command: ["echo 'Starting TabbyML in SMART CPU-ONLY mode...' && /opt/tabby/bin/tabby-cpu serve --model StarCoder-1B --chat-model Qwen2-1.5B-Instruct"]
    environment:
      TABBY_DEVICE: "cpu"
      RUST_LOG: "error"
      TABBY_DISABLE_USAGE_COLLECTION: "true"
      TABBY_MODEL_CACHE_ROOT: "/data"
      # Force CPU-only environment
      CUDA_VISIBLE_DEVICES: ""
      OMP_NUM_THREADS: "2"
    # No GPU resources allocation
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G

  # Awesome Code AI - Ensure CPU-only PyTorch
  awesome-code-ai:
    environment:
      PYTORCH_CPU_ONLY: "true"
      CUDA_VISIBLE_DEVICES: ""
    build:
      context: ./docker/awesome-code-ai
      dockerfile: Dockerfile
      args:
        PYTORCH_CPU_ONLY: "true"

  # Ollama - CPU-only mode
  ollama:
    environment:
      OLLAMA_NUM_PARALLEL: "1"
      OLLAMA_GPU_LAYERS: "0"
      CUDA_VISIBLE_DEVICES: ""