# Docker Compose Security Override
# This file applies security hardening to all services
version: '3.8'

services:
  # Apply security settings to all database services
  postgres:
    environment:
      - POSTGRES_HOST_AUTH_METHOD=md5  # Require password authentication
    user: "999:999"  # Run as postgres user, not root
    
  redis:
    user: "999:999"  # Run as redis user, not root
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}"]
    
  neo4j:
    user: "7474:7474"  # Run as neo4j user, not root
    
  # Security settings for application services  
  backend:
    user: "1001:1001"
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      
  frontend:
    user: "1001:1001" 
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    cap_drop:
      - ALL
      
  # Apply to monitoring services
  grafana:
    user: "472:472"  # Grafana user
    
  prometheus:
    user: "65534:65534"  # Nobody user
    
  # Agent security hardening
  ai-agent-orchestrator:
    user: "1001:1001"
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=50m
