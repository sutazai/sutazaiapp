%%{init: {'theme':'dark', 'themeVariables': { 'primaryColor':'#1f2937', 'primaryTextColor':'#fff', 'primaryBorderColor':'#7C3AED', 'lineColor':'#5b21b6', 'secondaryColor':'#6b7280', 'tertiaryColor':'#374151'}}}%%
graph TB
    subgraph "External Users"
        USER[Users<br/>Browser]
        ADMIN[Admins<br/>Browser]
        DEV[Developers<br/>API Clients]
    end
    
    subgraph "Ingress Layer"
        KONG[Kong Gateway<br/>:10005<br/>❌ Unconfigured]
        CONSUL[Consul<br/>:10006<br/>⚠️ Not utilized]
    end
    
    subgraph "Application Layer"
        UI[Frontend<br/>Streamlit<br/>:10011<br/>⚠️ Basic]
        API[Backend API<br/>FastAPI v17<br/>:10010<br/>⚠️ Degraded]
    end
    
    subgraph "Agent Layer [1/7 Functional]"
        TAC[Task Assignment<br/>:8551<br/>✅ Working]
        ORCH[AI Orchestrator<br/>:8589<br/>❌ Stub]
        MAC[Multi-Agent<br/>:8587<br/>❌ Stub]
        RAA[Resource Arbitration<br/>:8588<br/>❌ Stub]
        HRO[Hardware Optimizer<br/>:8002<br/>❌ Stub]
        OIS[Ollama Integration<br/>:11015<br/>❌ Stub]
        AME[Metrics Exporter<br/>:11063<br/>❌ Broken]
    end
    
    subgraph "AI/ML Layer"
        OLLAMA[Ollama Server<br/>:10104<br/>✅ tinyllama only]
    end
    
    subgraph "Data Persistence Layer"
        PG[(PostgreSQL<br/>:10000<br/>❌ No Schema)]
        REDIS[(Redis Cache<br/>:10001<br/>✅ Working)]
        NEO4J[(Neo4j Graph<br/>:10002<br/>⚠️ Not integrated)]
    end
    
    subgraph "Vector Store Layer"
        QDRANT[(Qdrant<br/>:10101<br/>⚠️ Not integrated)]
        CHROMA[(ChromaDB<br/>:10100<br/>⚠️ Connection issues)]
        FAISS[(FAISS<br/>:10103<br/>⚠️ Not integrated)]
    end
    
    subgraph "Messaging Layer"
        RABBIT[RabbitMQ<br/>:10007<br/>⚠️ Unconfigured]
    end
    
    subgraph "Monitoring Layer"
        PROM[Prometheus<br/>:10200<br/>✅ Working]
        GRAF[Grafana<br/>:10201<br/>✅ No dashboards]
        LOKI[Loki<br/>:10202<br/>✅ Working]
        ALERT[AlertManager<br/>:10203<br/>✅ No alerts]
    end
    
    %% User flows
    USER --> UI
    ADMIN --> GRAF
    DEV --> API
    
    %% Application dependencies
    UI --> API
    API --> KONG
    API -.->|Should use| CONSUL
    
    %% API to Data
    API --> PG
    API --> REDIS
    API -.->|Not wired| NEO4J
    
    %% API to AI
    API --> OLLAMA
    API -.->|Model mismatch| OLLAMA
    
    %% API to Agents
    API --> TAC
    API -.->|No real logic| ORCH
    API -.->|No real logic| MAC
    
    %% Agent dependencies
    TAC --> RABBIT
    TAC --> REDIS
    ORCH -.->|Should use| RABBIT
    MAC -.->|Should use| RABBIT
    RAA -.->|Should use| REDIS
    HRO -.->|Should use| PROM
    OIS -.->|Should use| OLLAMA
    AME -.->|Broken| PROM
    
    %% Vector stores (not integrated)
    API -.->|Not wired| QDRANT
    API -.->|Not wired| CHROMA
    API -.->|Not wired| FAISS
    
    %% Monitoring
    API --> PROM
    TAC --> PROM
    PROM --> GRAF
    API --> LOKI
    LOKI --> GRAF
    PROM --> ALERT
    
    %% Styling
    classDef working fill:#10b981,stroke:#065f46,stroke-width:2px,color:#fff
    classDef partial fill:#f59e0b,stroke:#d97706,stroke-width:2px,color:#fff
    classDef broken fill:#ef4444,stroke:#dc2626,stroke-width:2px,color:#fff
    classDef notintegrated fill:#6b7280,stroke:#4b5563,stroke-width:2px,color:#fff
    
    class REDIS,OLLAMA,TAC,PROM,LOKI,ALERT,GRAF working
    class UI,API,KONG,CONSUL,NEO4J,RABBIT partial
    class PG,ORCH,MAC,RAA,HRO,OIS,AME broken
    class QDRANT,CHROMA,FAISS notintegrated
    
    %% Legend
    subgraph "Legend"
        L1[✅ Working]:::working
        L2[⚠️ Partial/Issues]:::partial
        L3[❌ Broken/Stub]:::broken
        L4[⬜ Not Integrated]:::notintegrated
    end