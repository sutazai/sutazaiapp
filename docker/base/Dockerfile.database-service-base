FROM alpine:3.18

# Install required packages
RUN apk add --no-cache \
    curl \
    bash \
    && rm -rf /var/cache/apk/*

# Security: Create service user
ARG SERVICE_USER=serviceuser
ARG SERVICE_UID=1001
RUN addgroup -g ${SERVICE_UID} ${SERVICE_USER} && \
    adduser -D -u ${SERVICE_UID} -G ${SERVICE_USER} ${SERVICE_USER}

# Create data directory
RUN mkdir -p /data && chown -R ${SERVICE_USER}:${SERVICE_USER} /data

# Copy configuration files
COPY --chown=${SERVICE_USER}:${SERVICE_USER} config/ /config/

# Health check script
COPY --chown=${SERVICE_USER}:${SERVICE_USER} healthcheck.sh /healthcheck.sh
RUN chmod +x /healthcheck.sh

# Switch to service user
USER ${SERVICE_USER}

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD /healthcheck.sh

WORKDIR /data
