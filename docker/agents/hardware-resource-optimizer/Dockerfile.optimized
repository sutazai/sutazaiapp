# Hardware Resource Optimizer Agent - Ultra-Optimized Alpine Build
# Target: 70%+ size reduction from current 962MB image
# Multi-stage build optimized for edge computing
# Author: Edge Computing Optimization Specialist
# Date: August 10, 2025

# Use optimized Alpine base
FROM sutazai-python-alpine-optimized:v1.0.0 as base

# Hardware monitoring specific dependencies
COPY requirements.txt /tmp/agent-requirements.txt
RUN if [ -f /tmp/agent-requirements.txt ]; then \
      pip install --no-cache-dir --compile -r /tmp/agent-requirements.txt \
      && rm /tmp/agent-requirements.txt \
      && find /opt/venv -type d -name '__pycache__' -exec rm -rf {} + || true \
      && find /opt/venv -name '*.pyc' -delete; \
    fi

# Copy application code ( )
COPY app.py .
COPY shared/ ./shared/

# Agent-specific environment variables
ENV SERVICE_PORT=8080 \
    AGENT_ID=hardware-resource-optimizer \
    AGENT_NAME="Hardware Resource Optimizer" \
    AGENT_TYPE=hardware-resource-optimizer \
    # Hardware monitoring optimizations
    MONITORING_INTERVAL=30 \
    CPU_THRESHOLD=80 \
    MEMORY_THRESHOLD=90 \
    # Edge computing settings
    EDGE_MODE=true \
    RESOURCE_CONSTRAINTS=true

# Optimized health check for hardware monitoring
HEALTHCHECK --interval=60s --timeout=15s --start-period=30s --retries=2 \
    CMD curl -f http://localhost:8080/health || exit 1

# Expose port
EXPOSE 8080

# Already using non-root user from base image
# USER appuser

# Optimized startup with resource monitoring
CMD ["python", "-u", "app.py"]

# Edge computing metadata
LABEL edge.optimized="true" \
      edge.size.reduction="80%" \
      edge.original.size="962MB" \
      edge.target.size="<200MB" \
      edge.function="hardware-monitoring" \
      edge.resource.monitoring="enabled"