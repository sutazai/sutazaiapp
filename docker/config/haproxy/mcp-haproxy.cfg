# HAProxy Configuration for MCP Service Load Balancing
# Provides multi-client support and service discovery integration

global
    daemon
    maxconn 4096
    log stdout local0 info
    
    # Performance optimization
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor
    option redispatch
    retries 3
    timeout connect 5000ms
    timeout client 30000ms
    timeout server 30000ms
    timeout http-request 10000ms
    
    # Health check defaults
    option httpchk GET /health
    http-check expect status 200

# Statistics dashboard
stats enable
stats uri /stats
stats refresh 10s
stats show-node
stats show-legends
stats show-desc "MCP Service Load Balancer"

# Frontend for MCP service discovery
frontend mcp-discovery
    bind *:8080
    default_backend mcp-consul

# Frontend for individual MCP services
frontend mcp-postgres
    bind *:11100
    default_backend postgres-servers

frontend mcp-files
    bind *:11101
    default_backend files-servers

frontend mcp-http
    bind *:11102
    default_backend http-servers

frontend mcp-ddg
    bind *:11103
    default_backend ddg-servers

frontend mcp-github
    bind *:11104
    default_backend github-servers

frontend mcp-memory
    bind *:11105
    default_backend memory-servers

# Service discovery backend
backend mcp-consul
    balance roundrobin
    server consul1 mcp-consul-agent:8500 check

# MCP service backends with health checking
backend postgres-servers
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server postgres1 mcp-postgres:11100 check inter 10s rise 2 fall 3
    # Additional instances can be added dynamically

backend files-servers
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server files1 mcp-files:11101 check inter 10s rise 2 fall 3

backend http-servers
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server http1 mcp-http:11102 check inter 10s rise 2 fall 3

backend ddg-servers
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server ddg1 mcp-ddg:11103 check inter 10s rise 2 fall 3

backend github-servers
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server github1 mcp-github:11104 check inter 10s rise 2 fall 3

backend memory-servers
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server memory1 mcp-memory:11105 check inter 10s rise 2 fall 3

# Error pages for maintenance
errorfile 503 /etc/haproxy/errors/503.http
errorfile 502 /etc/haproxy/errors/502.http