# SutazAI Testing Environment Configuration
version: '3.8'

services:
  # Test database
  postgres-test:
    image: postgres:15-alpine
    container_name: sutazai-postgres-test
    environment:
      POSTGRES_DB: sutazai_test
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
    tmpfs:
      - /var/lib/postgresql/data  # Use tmpfs for speed
    networks:
      - sutazai-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d sutazai_test"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G

  # Test Redis
  redis-test:
    image: redis:7-alpine
    container_name: sutazai-redis-test
    command: redis-server --save ""  # No persistence for tests
    tmpfs:
      - /data
    networks:
      - sutazai-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 512M

  # Test backend
  backend-test:
    build:
      context: ../../backend
      dockerfile: ../docker/services/backend/Dockerfile
      target: builder  # Use builder stage for test dependencies
    container_name: sutazai-backend-test
    environment:
      DATABASE_URL: postgresql://test_user:test_password@postgres-test:5432/sutazai_test
      REDIS_URL: redis://redis-test:6379/0
      ENVIRONMENT: test
      LOG_LEVEL: DEBUG
      TESTING: true
    volumes:
      - ../../backend:/app:ro
      - ../../tests:/app/tests:ro
    networks:
      - sutazai-network
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    command: ["python", "-m", "pytest", "/app/tests", "-v", "--tb=short"]
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G

  # Test runner service
  test-runner:
    build:
      context: ../../tests
      dockerfile: Dockerfile
    container_name: sutazai-test-runner
    environment:
      BACKEND_URL: http://backend-test:8000
      DATABASE_URL: postgresql://test_user:test_password@postgres-test:5432/sutazai_test
      REDIS_URL: redis://redis-test:6379/0
      ENVIRONMENT: test
    volumes:
      - ../../tests:/app/tests:ro
      - ../../backend:/app/backend:ro
      - ../../frontend:/app/frontend:ro
      - ./test-results:/app/results
    networks:
      - sutazai-network
    depends_on:
      - backend-test
    command: ["python", "-m", "pytest", "/app/tests", "--junitxml=/app/results/junit.xml", "--cov=/app", "--cov-report=html:/app/results/coverage"]
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G

  # Mock external services for testing
  mock-ollama:
    image: wiremock/wiremock:latest
    container_name: sutazai-mock-ollama
    volumes:
      - ./test-mocks/ollama:/home/wiremock:ro
    networks:
      - sutazai-network
    ports:
      - "11434:8080"
    command: ["--global-response-templating", "--verbose"]
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M

# Test-specific network with faster settings
networks:
  sutazai-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"

# No persistent volumes for testing
volumes: {}