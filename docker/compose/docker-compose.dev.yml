# SutazAI Development Environment Overrides
# Use with: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  # Development overrides for backend
  backend:
    environment:
      LOG_LEVEL: DEBUG
      ENVIRONMENT: development
      DEBUG: true
      RELOAD: true
    volumes:
      - ../../backend:/app:delegated  # Live code reloading
      - /app/__pycache__  # Exclude cache
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload", "--log-level", "debug"]
    ports:
      - "8000:8000"  # Expose backend port in dev
    deploy:
      resources:
        limits:
          cpus: '4.0'  # More resources for development
          memory: 8G
        reservations:
          cpus: '1.0'
          memory: 2G

  # Development overrides for frontend  
  frontend:
    environment:
      STREAMLIT_SERVER_RUN_ON_SAVE: true
      STREAMLIT_SERVER_FILE_WATCHER_TYPE: poll
      ENVIRONMENT: development
      DEBUG: true
    volumes:
      - ../../frontend:/app:delegated  # Live code reloading
      - /app/__pycache__  # Exclude cache
    command: ["streamlit", "run", "app.py", "--server.port=8501", "--server.address=0.0.0.0", "--server.runOnSave=true"]
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G

  # Development database with exposed port
  postgres:
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: sutazai_dev
      POSTGRES_USER: sutazai_dev
      POSTGRES_PASSWORD: dev_password  # Simple password for dev
    # Override secrets for development
    secrets: []
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G

  # Development Redis with exposed port
  redis:
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes  # No password in dev
    environment: {}
    secrets: []

  # Development Ollama with more resources
  ollama:
    environment:
      OLLAMA_HOST: 0.0.0.0:11434
      OLLAMA_MODELS: /app/models
      OLLAMA_NUM_PARALLEL: 2  # More parallel requests in dev
      OLLAMA_MAX_LOADED_MODELS: 2
      OLLAMA_DEBUG: true
    ports:
      - "11434:11434"  # Expose Ollama port in dev
    deploy:
      resources:
        limits:
          cpus: '6.0'  # More CPU for development
          memory: 12G
        reservations:
          cpus: '2.0'
          memory: 4G

  # Development tools
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: sutazai-redis-commander
    environment:
      REDIS_HOSTS: local:redis:6379
    networks:
      - sutazai-network
    ports:
      - "8081:8081"
    depends_on:
      - redis
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: sutazai-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@sutazai.dev
      PGADMIN_DEFAULT_PASSWORD: dev_password
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    networks:
      - sutazai-network
    ports:
      - "8080:80"
    depends_on:
      - postgres
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

networks:
  sutazai-network:
    name: sutazai-network
    external: true

# Override secrets for development (use simple passwords)
# secrets:
#   postgres_password:
#     external: false
#   redis_password:
#     external: false
#   jwt_secret:
#     external: false
#   grafana_password:
#     external: false