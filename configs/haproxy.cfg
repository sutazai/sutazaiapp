global
    log stdout local0
    maxconn 4096
    daemon

defaults
    mode http
    log global
    option httplog
    option dontlognull
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    stats enable
    stats uri /stats
    stats refresh 30s

frontend api_gateway
    bind *:80
    option forwardfor
    
    # Route to different services based on path
    acl is_ollama path_beg /ollama
    acl is_ai_runtime path_beg /ai-runtime
    acl is_langflow path_beg /langflow
    acl is_flowise path_beg /flowise
    acl is_n8n path_beg /n8n
    
    use_backend ollama_backend if is_ollama
    use_backend ai_runtime_backend if is_ai_runtime
    use_backend langflow_backend if is_langflow
    use_backend flowise_backend if is_flowise
    use_backend n8n_backend if is_n8n
    
    default_backend ai_runtime_backend

backend ollama_backend
    balance roundrobin
    option httpchk GET /
    http-request set-path %[path,regsub(^/ollama/?,/)]
    server ollama1 ollama:11434 check

backend ai_runtime_backend
    balance roundrobin
    option httpchk GET /health
    http-request set-path %[path,regsub(^/ai-runtime/?,/)]
    server runtime1 ai-runtime:8000 check

backend langflow_backend
    balance roundrobin
    option httpchk GET /health
    http-request set-path %[path,regsub(^/langflow/?,/)]
    server langflow1 langflow:7860 check

backend flowise_backend
    balance roundrobin
    option httpchk GET /api/v1/ping
    http-request set-path %[path,regsub(^/flowise/?,/)]
    server flowise1 flowise:3000 check

backend n8n_backend
    balance roundrobin
    option httpchk GET /healthz
    http-request set-path %[path,regsub(^/n8n/?,/)]
    server n8n1 n8n:5678 check