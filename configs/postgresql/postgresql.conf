# PostgreSQL Configuration - Optimized for SutazAI Production
# High-performance settings for container deployment
# Optimized for 4GB RAM, 4 CPU cores

# CONNECTION SETTINGS
max_connections = 200                    # Increased from default 100
superuser_reserved_connections = 3

# MEMORY SETTINGS
shared_buffers = 1GB                     # 25% of system RAM (4GB)
effective_cache_size = 3GB               # 75% of system RAM
work_mem = 16MB                          # Per connection work memory
maintenance_work_mem = 256MB             # For maintenance operations
max_stack_depth = 7MB

# WRITE AHEAD LOGGING (WAL)
wal_level = replica                      # Enable replication
wal_buffers = 16MB                       # WAL buffer size
max_wal_size = 2GB                       # Maximum WAL size
min_wal_size = 80MB                      # Minimum WAL size
checkpoint_completion_target = 0.9       # Smooth checkpoints
checkpoint_timeout = 15min               # Checkpoint frequency

# QUERY PLANNER
random_page_cost = 1.1                   # For SSD storage
effective_io_concurrency = 200           # For SSD parallel I/O
seq_page_cost = 1.0                      # Sequential scan cost

# BACKGROUND WRITER
bgwriter_delay = 200ms                   # Background writer delay
bgwriter_lru_maxpages = 100             # Pages to write per round
bgwriter_lru_multiplier = 2.0           # Multiplier for next round

# AUTOVACUUM (Critical for Performance)
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.1
autovacuum_vacuum_cost_delay = 10ms
autovacuum_vacuum_cost_limit = 1000

# LOCK MANAGEMENT
max_locks_per_transaction = 64
max_pred_locks_per_transaction = 64

# ERROR REPORTING AND LOGGING
log_destination = 'stderr'
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_file_mode = 0644
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 1000        # Log slow queries (1 second)
log_connections = off                     # Disable in production for performance
log_disconnections = off
log_lock_waits = on                      # Log lock waits
log_statement = 'none'                   # Log no statements by default
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# PERFORMANCE MONITORING
track_activities = on
track_counts = on
track_io_timing = on                     # Enable I/O timing (slight overhead)
track_functions = all
stats_temp_directory = '/var/run/postgresql/stats_temp'

# CLIENT CONNECTION DEFAULTS
default_text_search_config = 'pg_catalog.english'
timezone = 'UTC'
datestyle = 'iso, mdy'
lc_messages = 'C'
lc_monetary = 'C'
lc_numeric = 'C'
lc_time = 'C'

# RESOURCE USAGE
max_worker_processes = 8
max_parallel_workers = 4
max_parallel_workers_per_gather = 2
max_parallel_maintenance_workers = 2

# REPLICATION (for future high availability)
# Enable for master-slave replication
# archive_mode = on
# archive_command = 'cp %p /var/lib/postgresql/archive/%f'
# max_wal_senders = 3
# wal_keep_segments = 32

# SECURITY
ssl = off                                # Enable in production with certs
password_encryption = scram-sha-256      # Strong password encryption

# EXTENSIONS
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.max = 10000
pg_stat_statements.track = all