groups:
  - name: sutazai.critical
    rules:
      # Critical System Alerts
      - alert: SutazAIBackendDown
        expr: up{job="sutazai-backend"} == 0
        for: 1m
        labels:
          severity: critical
          service: backend
          component: core
        annotations:
          summary: "SutazAI Backend is down"
          description: "Backend API server has been down for more than 1 minute. System is completely unavailable."
          runbook_url: "https://docs.sutazai.com/runbooks/backend-down"
          action: "Restart backend service immediately"

      - alert: OllamaServiceDown
        expr: up{job="ollama"} == 0
        for: 2m
        labels:
          severity: critical
          service: ollama
          component: ml
        annotations:
          summary: "Ollama service is down"
          description: "Ollama model server has been unreachable for 2 minutes. AI inference is unavailable."
          runbook_url: "https://docs.sutazai.com/runbooks/ollama-down"
          action: "Check Ollama container and restart if necessary"

      - alert: CriticalAgentFailure
        expr: count(up{job="sutazai-agents"} == 0) > 5
        for: 2m
        labels:
          severity: critical
          service: agents
          component: multiagent
        annotations:
          summary: "Multiple critical agents are down"
          description: "{{ $value }} agents are currently down, affecting system capabilities."
          runbook_url: "https://docs.sutazai.com/runbooks/agent-failures"
          action: "Investigate agent container health and restart failed agents"

      - alert: DatabaseConnectionFailure
        expr: up{job="postgres"} == 0
        for: 30s
        labels:
          severity: critical
          service: postgres
          component: database
        annotations:
          summary: "Database is unreachable"
          description: "PostgreSQL database has been unreachable for 30 seconds."
          runbook_url: "https://docs.sutazai.com/runbooks/database-down"
          action: "Check database container and connection"

      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          service: redis
          component: cache
        annotations:
          summary: "Redis cache is down"
          description: "Redis cache service is unreachable, affecting task queuing and caching."
          runbook_url: "https://docs.sutazai.com/runbooks/redis-down"
          action: "Restart Redis container"

  - name: sutazai.performance
    rules:
      # Performance Alerts
      - alert: HighAPILatency
        expr: histogram_quantile(0.95, rate(sutazai_api_request_duration_seconds_bucket[5m])) > 2
        for: 3m
        labels:
          severity: warning
          service: backend
          component: api
        annotations:
          summary: "High API response latency"
          description: "95th percentile API latency is {{ $value }}s for 3 minutes"
          runbook_url: "https://docs.sutazai.com/runbooks/high-latency"

      - alert: HighErrorRate
        expr: rate(sutazai_api_requests_total{status=~"5.."}[5m]) / rate(sutazai_api_requests_total[5m]) > 0.05
        for: 2m
        labels:
          severity: warning
          service: backend
          component: api
        annotations:
          summary: "High API error rate"
          description: "API error rate is {{ $value | humanizePercentage }} for 2 minutes"
          runbook_url: "https://docs.sutazai.com/runbooks/high-error-rate"

      - alert: SlowAgentTaskProcessing
        expr: histogram_quantile(0.95, rate(sutazai_agent_task_duration_seconds_bucket[5m])) > 30
        for: 5m
        labels:
          severity: warning
          service: agents
          component: processing
        annotations:
          summary: "Slow agent task processing"
          description: "95th percentile agent task duration is {{ $value }}s, indicating performance issues"
          runbook_url: "https://docs.sutazai.com/runbooks/slow-agents"

      - alert: ModelInferenceLatency
        expr: histogram_quantile(0.95, rate(sutazai_model_inference_duration_seconds_bucket[5m])) > 10
        for: 3m
        labels:
          severity: warning
          service: ollama
          component: inference
        annotations:
          summary: "High model inference latency"
          description: "Model inference taking {{ $value }}s at 95th percentile"
          runbook_url: "https://docs.sutazai.com/runbooks/slow-inference"

  - name: sutazai.resources
    rules:
      # Resource Usage Alerts
      - alert: HighCPUUsage
        expr: 100 * rate(container_cpu_usage_seconds_total{name=~"sutazai-.*"}[5m]) > 80
        for: 10m
        labels:
          severity: warning
          service: system
          component: cpu
        annotations:
          summary: "High CPU usage on {{ $labels.name }}"
          description: "Container {{ $labels.name }} CPU usage is {{ $value }}% for 10 minutes"
          runbook_url: "https://docs.sutazai.com/runbooks/high-cpu"

      - alert: HighMemoryUsage
        expr: (container_memory_usage_bytes{name=~"sutazai-.*"} / container_spec_memory_limit_bytes{name=~"sutazai-.*"}) * 100 > 90
        for: 5m
        labels:
          severity: warning
          service: system
          component: memory
        annotations:
          summary: "High memory usage on {{ $labels.name }}"
          description: "Container {{ $labels.name }} memory usage is {{ $value }}% of limit"
          runbook_url: "https://docs.sutazai.com/runbooks/high-memory"

      - alert: DiskSpaceRunningLow
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          service: system
          component: disk
        annotations:
          summary: "Disk space running low"
          description: "Disk usage is {{ $value }}% on {{ $labels.device }}"
          runbook_url: "https://docs.sutazai.com/runbooks/disk-space"

      - alert: SystemLoadHigh
        expr: node_load15 > 4
        for: 10m
        labels:
          severity: warning
          service: system
          component: load
        annotations:
          summary: "System load is high"
          description: "15-minute load average is {{ $value }}"
          runbook_url: "https://docs.sutazai.com/runbooks/high-load"

  - name: sutazai.agents
    rules:
      # Agent-Specific Alerts
      - alert: AgentTaskBacklog
        expr: sutazai_task_queue_size > 50
        for: 15m
        labels:
          severity: warning
          service: agents
          component: queue
        annotations:
          summary: "Agent task backlog is high"
          description: "Queue {{ $labels.queue_name }} has {{ $value }} queued tasks for 15 minutes"
          runbook_url: "https://docs.sutazai.com/runbooks/task-backlog"

      - alert: AgentUnresponsive
        expr: time() - sutazai_agent_last_heartbeat_timestamp > 300
        for: 0m
        labels:
          severity: critical
          service: agents
          component: heartbeat
        annotations:
          summary: "Agent is unresponsive"
          description: "Agent {{ $labels.agent_name }} hasn't sent heartbeat for 5 minutes"
          runbook_url: "https://docs.sutazai.com/runbooks/unresponsive-agent"
          action: "Restart unresponsive agent"

      - alert: HighAgentErrorRate
        expr: rate(sutazai_agent_tasks_failed_total[5m]) / rate(sutazai_agent_tasks_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: agents
          component: execution
        annotations:
          summary: "High agent error rate"
          description: "Agent {{ $labels.agent_name }} error rate is {{ $value | humanizePercentage }}"
          runbook_url: "https://docs.sutazai.com/runbooks/agent-errors"

      - alert: AgentMemoryLeak
        expr: increase(container_memory_usage_bytes{name=~"sutazai-.*agent.*"}[1h]) > 100000000
        for: 0m
        labels:
          severity: warning
          service: agents
          component: memory
        annotations:
          summary: "Potential memory leak in agent"
          description: "Agent {{ $labels.name }} memory increased by {{ $value | humanize1024 }} in 1 hour"
          runbook_url: "https://docs.sutazai.com/runbooks/memory-leak"

  - name: sutazai.orchestration
    rules:
      # Orchestration and Workflow Alerts
      - alert: WorkflowExecutionStalled
        expr: increase(sutazai_agent_tasks_completed_total[10m]) == 0
        for: 10m
        labels:
          severity: warning
          service: orchestration
          component: workflow
        annotations:
          summary: "Workflow execution appears stalled"
          description: "No tasks completed in the last 10 minutes, indicating workflow issues"
          runbook_url: "https://docs.sutazai.com/runbooks/workflow-stalled"

      - alert: OrchestratorDown
        expr: up{job="sutazai-agents", instance=~".*orchestr.*"} == 0
        for: 2m
        labels:
          severity: critical
          service: orchestration
          component: orchestrator
        annotations:
          summary: "Orchestrator is down"
          description: "Core orchestrator {{ $labels.instance }} is down"
          runbook_url: "https://docs.sutazai.com/runbooks/orchestrator-down"
          action: "Restart orchestrator immediately"

      - alert: CoordinationLatency
        expr: histogram_quantile(0.95, rate(sutazai_task_processing_time_seconds_bucket[5m])) > 60
        for: 5m
        labels:
          severity: warning
          service: orchestration
          component: coordination
        annotations:
          summary: "High coordination latency"
          description: "95th percentile task coordination time is {{ $value }}s"
          runbook_url: "https://docs.sutazai.com/runbooks/coordination-latency"

  - name: sutazai.database
    rules:
      # Database Performance Alerts
      - alert: DatabaseConnectionsHigh
        expr: pg_stat_database_numbackends / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
          service: postgres
          component: connections
        annotations:
          summary: "Database connection usage is high"
          description: "Database connections are at {{ $value | humanizePercentage }} of maximum"
          runbook_url: "https://docs.sutazai.com/runbooks/db-connections"

      - alert: DatabaseQueryLatency
        expr: histogram_quantile(0.95, rate(pg_stat_statements_mean_time_bucket[5m])) > 1000
        for: 3m
        labels:
          severity: warning
          service: postgres
          component: performance
        annotations:
          summary: "High database query latency"
          description: "95th percentile query time is {{ $value }}ms"
          runbook_url: "https://docs.sutazai.com/runbooks/db-latency"

      - alert: DatabaseLockWaits
        expr: pg_stat_database_tup_updated{datname="sutazai"} > 1000
        for: 5m
        labels:
          severity: warning
          service: postgres
          component: locks
        annotations:
          summary: "High database lock waits"
          description: "Database experiencing high lock contention"
          runbook_url: "https://docs.sutazai.com/runbooks/db-locks"

  - name: sutazai.security
    rules:
      # Security and Safety Alerts
      - alert: UnauthorizedAPIAccess
        expr: rate(sutazai_api_requests_total{status="401"}[5m]) > 5
        for: 1m
        labels:
          severity: warning
          service: security
          component: authentication
        annotations:
          summary: "High rate of unauthorized API access attempts"
          description: "{{ $value }} unauthorized access attempts per second"
          runbook_url: "https://docs.sutazai.com/runbooks/unauthorized-access"

      - alert: RateLimitExceeded
        expr: rate(sutazai_api_requests_total{status="429"}[5m]) > 10
        for: 2m
        labels:
          severity: warning
          service: security
          component: rate_limiting
        annotations:
          summary: "High rate of rate limit violations"
          description: "{{ $value }} rate limit violations per second"
          runbook_url: "https://docs.sutazai.com/runbooks/rate-limits"

      - alert: SuspiciousAgentBehavior
        expr: rate(sutazai_agent_tasks_failed_total{error_type="security_violation"}[5m]) > 0
        for: 0m
        labels:
          severity: critical
          service: security
          component: agent_behavior
        annotations:
          summary: "Suspicious agent behavior detected"
          description: "Agent {{ $labels.agent_name }} triggered security violations"
          runbook_url: "https://docs.sutazai.com/runbooks/suspicious-behavior"
          action: "Immediately isolate and investigate agent"

  - name: sutazai.monitoring
    rules:
      # Monitoring Infrastructure Alerts
      - alert: PrometheusTargetDown
        expr: up == 0
        for: 2m
        labels:
          severity: warning
          service: monitoring
          component: prometheus
        annotations:
          summary: "Prometheus target is down"
          description: "Prometheus target {{ $labels.job }}/{{ $labels.instance }} is down"
          runbook_url: "https://docs.sutazai.com/runbooks/prometheus-target"

      - alert: GrafanaDown
        expr: up{job="grafana"} == 0
        for: 2m
        labels:
          severity: warning
          service: monitoring
          component: grafana
        annotations:
          summary: "Grafana is down"
          description: "Grafana monitoring dashboard is unreachable"
          runbook_url: "https://docs.sutazai.com/runbooks/grafana-down"

      - alert: AlertManagerDown
        expr: up{job="alertmanager"} == 0
        for: 1m
        labels:
          severity: critical
          service: monitoring
          component: alertmanager
        annotations:
          summary: "AlertManager is down"
          description: "AlertManager is down, alerts will not be processed"
          runbook_url: "https://docs.sutazai.com/runbooks/alertmanager-down"
          action: "Restart AlertManager immediately"

      - alert: JaegerDown
        expr: up{job="jaeger"} == 0
        for: 5m
        labels:
          severity: warning
          service: monitoring
          component: tracing
        annotations:
          summary: "Jaeger tracing is down"
          description: "Distributed tracing system is unavailable"
          runbook_url: "https://docs.sutazai.com/runbooks/jaeger-down"

      - alert: LokiDown
        expr: up{job="loki"} == 0
        for: 3m
        labels:
          severity: warning
          service: monitoring
          component: logging
        annotations:
          summary: "Loki log aggregation is down"
          description: "Log aggregation system is unavailable"
          runbook_url: "https://docs.sutazai.com/runbooks/loki-down"