global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'sutazai-alerts@localhost'
  smtp_auth_username: ''
  smtp_auth_password: ''
  smtp_require_tls: false
  resolve_timeout: 5m

# Webhook receivers for SutazAI system
webhook_configs:
  slack_api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
  teams_webhook_url: 'https://outlook.office.com/webhook/YOUR/TEAMS/WEBHOOK'

route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'
  routes:
    # Critical Agent Failures
    - match:
        severity: critical
        service: agents
      receiver: 'critical-agent-alerts'
      group_wait: 5s
      repeat_interval: 15m
      
    # Backend/API Issues
    - match:
        severity: critical
        service: backend
      receiver: 'backend-critical-alerts'
      group_wait: 5s
      repeat_interval: 10m
      
    # Model Server Issues
    - match:
        service: ollama
      receiver: 'model-server-alerts'
      group_wait: 30s
      repeat_interval: 30m
      
    # Database Issues
    - match:
        service: postgres
      receiver: 'database-alerts'
      group_wait: 30s
      repeat_interval: 30m
      
    # Orchestration Issues
    - match:
        service: orchestration
      receiver: 'orchestration-alerts'
      group_wait: 15s
      repeat_interval: 20m
      
    # Performance Warnings
    - match:
        severity: warning
      receiver: 'performance-warnings'
      group_wait: 2m
      repeat_interval: 1h
      
    # General System Alerts
    - match:
        severity: info
      receiver: 'system-info'
      group_wait: 5m
      repeat_interval: 6h

receivers:
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://sutazai-backend:8000/api/v1/alerts/webhook'
        send_resolved: true
        http_config:
          bearer_token: 'your-webhook-token'
        title: 'SutazAI Alert: {{ .GroupLabels.alertname }}'
        text: >
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Severity: {{ .Labels.severity }}
          Service: {{ .Labels.service }}
          {{ end }}

  - name: 'critical-agent-alerts'
    email_configs:
      - to: 'admin@sutazai.com'
        subject: 'CRITICAL: SutazAI Agent Failure'
        body: |
          CRITICAL ALERT: One or more AI agents have failed
          
          {{ range .Alerts }}
          Agent: {{ .Labels.agent_name | default "Unknown" }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Time: {{ .StartsAt }}
          {{ end }}
          
          Immediate action required to maintain system functionality.
    slack_configs:
      - api_url: '{{ .webhook_configs.slack_api_url }}'
        channel: '#sutazai-critical'
        title: 'CRITICAL: Agent Failure'
        text: >
          üö® CRITICAL AGENT FAILURE üö®
          {{ range .Alerts }}
          Agent: {{ .Labels.agent_name | default "Unknown" }}
          Issue: {{ .Annotations.summary }}
          {{ end }}
        send_resolved: true
    webhook_configs:
      - url: 'http://sutazai-backend:8000/api/v1/agents/emergency-restart'
        send_resolved: false
        http_config:
          bearer_token: 'emergency-restart-token'

  - name: 'backend-critical-alerts'
    email_configs:
      - to: 'admin@sutazai.com'
        subject: 'CRITICAL: SutazAI Backend Failure'
        body: |
          CRITICAL: Backend system failure detected
          
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Service: {{ .Labels.service }}
          Time: {{ .StartsAt }}
          {{ end }}
          
          System may be completely unavailable.
    slack_configs:
      - api_url: '{{ .webhook_configs.slack_api_url }}'
        channel: '#sutazai-critical'
        title: 'CRITICAL: Backend Down'
        text: 'üî• Backend system is down! Immediate attention required.'
        send_resolved: true

  - name: 'model-server-alerts'
    email_configs:
      - to: 'ml-team@sutazai.com'
        subject: 'SutazAI Model Server Alert'
        body: |
          Model server issue detected:
          
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Model: {{ .Labels.model_name | default "Unknown" }}
          Description: {{ .Annotations.description }}
          {{ end }}
    slack_configs:
      - api_url: '{{ .webhook_configs.slack_api_url }}'
        channel: '#sutazai-models'
        title: 'Model Server Alert'
        text: >
          ü§ñ Model server issue:
          {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}

  - name: 'database-alerts'
    email_configs:
      - to: 'db-team@sutazai.com'
        subject: 'SutazAI Database Alert'
        body: |
          Database issue detected:
          
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Database: {{ .Labels.datname | default "sutazai" }}
          {{ end }}
    slack_configs:
      - api_url: '{{ .webhook_configs.slack_api_url }}'
        channel: '#sutazai-infrastructure'
        title: 'Database Alert'
        text: >
          üíæ Database issue:
          {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}

  - name: 'orchestration-alerts'
    email_configs:
      - to: 'orchestration-team@sutazai.com'
        subject: 'SutazAI Orchestration Alert'
        body: |
          Multi-agent orchestration issue:
          
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Workflow: {{ .Labels.workflow_id | default "Unknown" }}
          {{ end }}
    slack_configs:
      - api_url: '{{ .webhook_configs.slack_api_url }}'
        channel: '#sutazai-orchestration'
        title: 'Orchestration Alert'
        text: >
          üé≠ Orchestration issue:
          {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}

  - name: 'performance-warnings'
    email_configs:
      - to: 'performance-team@sutazai.com'
        subject: 'SutazAI Performance Warning'
        body: |
          Performance degradation detected:
          
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Service: {{ .Labels.service }}
          Severity: {{ .Labels.severity }}
          {{ end }}
    slack_configs:
      - api_url: '{{ .webhook_configs.slack_api_url }}'
        channel: '#sutazai-performance'
        title: 'Performance Warning'
        text: >
          ‚ö†Ô∏è Performance issue:
          {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}

  - name: 'system-info'
    slack_configs:
      - api_url: '{{ .webhook_configs.slack_api_url }}'
        channel: '#sutazai-general'
        title: 'System Information'
        text: >
          ‚ÑπÔ∏è System info:
          {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
        send_resolved: true

# Inhibition rules to prevent alert spam
inhibit_rules:
  # Inhibit any warning-level alerts if there are critical alerts for the same service
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['service', 'instance']
    
  # Inhibit agent-specific alerts if the backend is down
  - source_match:
      alertname: 'SutazAIBackendDown'
    target_match_re:
      alertname: '.*Agent.*'
    equal: ['cluster']
    
  # Inhibit individual container alerts if the whole node is down
  - source_match:
      alertname: 'NodeDown'
    target_match_re:
      alertname: '.*Container.*'
    equal: ['instance']

# Templates for custom alert formatting
templates:
  - '/etc/alertmanager/templates/*.tmpl'