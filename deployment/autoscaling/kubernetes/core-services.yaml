apiVersion: v1
kind: Service
metadata:
  name: sutazai-backend
  namespace: sutazai
  labels:
    app: sutazai-backend
    tier: backend
spec:
  type: ClusterIP
  ports:
    - port: 8000
      targetPort: 8000
      protocol: TCP
      name: http
  selector:
    app: sutazai-backend

---
apiVersion: v1
kind: Service
metadata:
  name: sutazai-frontend
  namespace: sutazai
  labels:
    app: sutazai-frontend
    tier: frontend
spec:
  type: ClusterIP
  ports:
    - port: 3000
      targetPort: 3000
      protocol: TCP
      name: http
  selector:
    app: sutazai-frontend

---
apiVersion: v1
kind: Service
metadata:
  name: sutazai-ollama
  namespace: sutazai
  labels:
    app: sutazai-ollama
    tier: ai
spec:
  type: ClusterIP
  ports:
    - port: 11434
      targetPort: 11434
      protocol: TCP
      name: http
  selector:
    app: sutazai-ollama

---
apiVersion: v1
kind: Service
metadata:
  name: sutazai-autogpt
  namespace: sutazai
  labels:
    app: sutazai-autogpt
    tier: ai
spec:
  type: ClusterIP
  ports:
    - port: 8100
      targetPort: 8100
      protocol: TCP
      name: http
  selector:
    app: sutazai-autogpt

---
apiVersion: v1
kind: Service
metadata:
  name: sutazai-crewai
  namespace: sutazai
  labels:
    app: sutazai-crewai
    tier: ai
spec:
  type: ClusterIP
  ports:
    - port: 8200
      targetPort: 8200
      protocol: TCP
      name: http
  selector:
    app: sutazai-crewai

---
apiVersion: v1
kind: Service
metadata:
  name: sutazai-chromadb
  namespace: sutazai
  labels:
    app: sutazai-chromadb
    tier: data
spec:
  type: ClusterIP
  ports:
    - port: 8001
      targetPort: 8000
      protocol: TCP
      name: http
  selector:
    app: sutazai-chromadb

---
apiVersion: v1
kind: Service
metadata:
  name: sutazai-qdrant
  namespace: sutazai
  labels:
    app: sutazai-qdrant
    tier: data
spec:
  type: ClusterIP
  ports:
    - port: 6333
      targetPort: 6333
      protocol: TCP
      name: http
    - port: 6334
      targetPort: 6334
      protocol: TCP
      name: grpc
  selector:
    app: sutazai-qdrant

---
apiVersion: v1
kind: Service
metadata:
  name: sutazai-postgres
  namespace: sutazai
  labels:
    app: sutazai-postgres
    tier: data
spec:
  type: ClusterIP
  ports:
    - port: 5432
      targetPort: 5432
      protocol: TCP
      name: postgres
  selector:
    app: sutazai-postgres

---
apiVersion: v1
kind: Service
metadata:
  name: sutazai-redis
  namespace: sutazai
  labels:
    app: sutazai-redis
    tier: data
spec:
  type: ClusterIP
  ports:
    - port: 6379
      targetPort: 6379
      protocol: TCP
      name: redis
  selector:
    app: sutazai-redis

---
apiVersion: v1
kind: Service
metadata:
  name: sutazai-flowise
  namespace: sutazai
  labels:
    app: sutazai-flowise
    tier: ai
spec:
  type: ClusterIP
  ports:
    - port: 3000
      targetPort: 3000
      protocol: TCP
      name: http
  selector:
    app: sutazai-flowise

---
apiVersion: v1
kind: Service
metadata:
  name: sutazai-n8n
  namespace: sutazai
  labels:
    app: sutazai-n8n
    tier: automation
spec:
  type: ClusterIP
  ports:
    - port: 5678
      targetPort: 5678
      protocol: TCP
      name: http
  selector:
    app: sutazai-n8n

---
# Headless service for StatefulSets
apiVersion: v1
kind: Service
metadata:
  name: sutazai-postgres-headless
  namespace: sutazai
  labels:
    app: sutazai-postgres
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - port: 5432
      targetPort: 5432
      protocol: TCP
      name: postgres
  selector:
    app: sutazai-postgres

---
# Monitoring services
apiVersion: v1
kind: Service
metadata:
  name: prometheus
  namespace: sutazai
  labels:
    app: prometheus
    tier: monitoring
spec:
  type: ClusterIP
  ports:
    - port: 9090
      targetPort: 9090
      protocol: TCP
      name: http
  selector:
    app: prometheus

---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: sutazai
  labels:
    app: grafana
    tier: monitoring
spec:
  type: ClusterIP
  ports:
    - port: 3000
      targetPort: 3000
      protocol: TCP
      name: http
  selector:
    app: grafana

---
apiVersion: v1
kind: Service
metadata:
  name: alertmanager
  namespace: sutazai
  labels:
    app: alertmanager
    tier: monitoring
spec:
  type: ClusterIP
  ports:
    - port: 9093
      targetPort: 9093
      protocol: TCP
      name: http
  selector:
    app: alertmanager

---
apiVersion: v1
kind: Service
metadata:
  name: loki
  namespace: sutazai
  labels:
    app: loki
    tier: monitoring
spec:
  type: ClusterIP
  ports:
    - port: 3100
      targetPort: 3100
      protocol: TCP
      name: http
  selector:
    app: loki

---
# Network policies for service isolation
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: sutazai-backend-network-policy
  namespace: sutazai
spec:
  podSelector:
    matchLabels:
      app: sutazai-backend
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: sutazai-frontend
        - podSelector:
            matchLabels:
              app: ingress-nginx
        - podSelector:
            matchLabels:
              app: traefik
      ports:
        - protocol: TCP
          port: 8000
  egress:
    - to:
        - podSelector:
            matchLabels:
              tier: data
        - podSelector:
            matchLabels:
              tier: ai
      ports:
        - protocol: TCP
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: sutazai-ai-services-network-policy
  namespace: sutazai
spec:
  podSelector:
    matchLabels:
      tier: ai
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: sutazai-backend
        - podSelector:
            matchLabels:
              app: ingress-nginx
        - podSelector:
            matchLabels:
              app: traefik
      ports:
        - protocol: TCP
  egress:
    - to:
        - podSelector:
            matchLabels:
              tier: data
      ports:
        - protocol: TCP
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 53
    # Allow external model downloads
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 169.254.169.254/32
      ports:
        - protocol: TCP
          port: 443