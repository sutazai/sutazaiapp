# Upstream configuration for Docker Swarm services
# Load balancing pools for SutazAI services

# Backend services pool
upstream backend_backend {
    least_conn;
    server sutazai-backend:8000 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# Frontend services pool
upstream frontend_backend {
    ip_hash;  # Sticky sessions for frontend
    server sutazai-frontend:8501 max_fails=3 fail_timeout=30s;
}

# Ollama AI services pool
upstream ollama_backend {
    least_conn;  # Distribute AI workload evenly
    server sutazai-ollama:11434 max_fails=2 fail_timeout=60s;
    keepalive 16;
}

# ChromaDB vector database pool
upstream chromadb_backend {
    round_robin;
    server sutazai-chromadb:8000 max_fails=3 fail_timeout=30s;
}

# Qdrant vector database pool
upstream qdrant_backend {
    round_robin;
    server sutazai-qdrant:6333 max_fails=3 fail_timeout=30s;
}

# AutoGPT agent pool
upstream autogpt_backend {
    least_conn;
    server sutazai-autogpt:8080 max_fails=3 fail_timeout=30s;
}

# CrewAI agent pool
upstream crewai_backend {
    least_conn;
    server sutazai-crewai:8080 max_fails=3 fail_timeout=30s;
}

# Aider agent pool
upstream aider_backend {
    least_conn;
    server sutazai-aider:8080 max_fails=3 fail_timeout=30s;
}