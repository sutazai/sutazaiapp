# Ollama Integration Rollout Phases Configuration
# Zero-downtime deployment with canary rollouts

deployment:
  name: "ollama-integration-v2"
  version: "2.0.0"
  target_agents: 131
  deployment_type: "blue-green-canary"
  max_duration: "5h"
  
environment:
  hardware:
    total_ram_gb: 48
    gpu_memory_gb: 4
    cpu_cores: 16
  constraints:
    ollama_parallel: 2
    max_memory_per_agent_mb: 256
    max_concurrent_deployments: 5

# Rollout phases with specific agent targeting
phases:
  # Phase 1: Canary - Lowest risk agents
  canary:
    name: "Canary Deployment"
    percentage: 10
    agent_count: 13
    duration: "30m"
    timeout: "45m"
    
    # Target the lowest risk agents first
    target_agents:
      - "metrics-collector-prometheus"
      - "log-aggregator-loki"
      - "health-monitor"
      - "resource-visualiser"
      - "observability-dashboard-manager-grafana"
      - "system-performance-forecaster"
      - "energy-consumption-optimize"
      - "garbage-collector"
      - "experiment-tracker"
      - "data-drift-detector"
      - "system-knowledge-curator"
      - "evolution-strategy-trainer"
      - "runtime-behavior-anomaly-detector"
    
    success_criteria:
      error_rate_threshold: 0.1  # 0.1% max error increase
      response_time_multiplier: 2.0  # Max 2x baseline response time
      memory_usage_multiplier: 1.2  # Max 120% of baseline memory
      cpu_usage_multiplier: 1.1   # Max 110% of baseline CPU
      health_check_success_rate: 1.0  # 100% health checks passing
      ollama_success_rate: 0.99   # 99% Ollama queries successful
      circuit_breaker_trips: 0    # No circuit breaker trips allowed
      
    monitoring:
      metrics_interval: "30s"
      health_check_interval: "15s"
      rollback_check_interval: "60s"
      
    rollback_triggers:
      - condition: "error_rate > 5%"
        severity: "critical"
        action: "immediate_rollback"
      - condition: "memory_usage > 90%"
        severity: "critical"
        action: "immediate_rollback"
      - condition: "response_time > 5x baseline"
        severity: "high"
        action: "pause_and_evaluate"
      - condition: "health_check_failures > 2"
        severity: "high" 
        action: "immediate_rollback"

  # Phase 2: Limited rollout - Development agents
  limited:
    name: "Limited Rollout"
    percentage: 25
    agent_count: 32
    duration: "45m"
    timeout: "60m"
    
    depends_on:
      - phase: "canary"
        status: "success"
        
    target_agents:
      - "ai-agent-debugger"
      - "code-improver"
      - "testing-qa-validator"
      - "testing-qa-team-lead"
      - "code-quality-gateway-sonarqube"
      - "mega-code-auditor"
      - "semgrep-security-analyzer"
      - "container-vulnerability-scanner-trivy"
      - "explainability-and-transparency-agent"
      - "bias-and-fairness-auditor"
      - "prompt-injection-guard"
      - "honeypot-deployment-agent"
      - "edge-inference-proxy"
      - "neural-architecture-search"
      - "genetic-algorithm-tuner"
      - "ml-experiment-tracker-mlflow"
      - "data-lifecycle-manager"
      - "data-version-controller-dvc"
      - "distributed-tracing-analyzer-jaeger"
      
    success_criteria:
      error_rate_threshold: 0.2
      response_time_multiplier: 1.8
      memory_usage_multiplier: 1.2
      cpu_usage_multiplier: 1.15
      health_check_success_rate: 0.99
      ollama_success_rate: 0.98
      circuit_breaker_trips: 1
      task_completion_rate: 0.995
      
    monitoring:
      metrics_interval: "45s"
      health_check_interval: "20s"
      rollback_check_interval: "90s"
      
    rollback_triggers:
      - condition: "error_rate > 3%"
        severity: "critical"
        action: "immediate_rollback"
      - condition: "memory_usage > 85%"
        severity: "critical"
        action: "immediate_rollback"
      - condition: "ollama_failures > 5%"
        severity: "high"
        action: "pause_and_evaluate"

  # Phase 3: Production rollout - Business logic agents  
  production:
    name: "Production Rollout"
    percentage: 50
    agent_count: 65
    duration: "60m"
    timeout: "75m"
    
    depends_on:
      - phase: "limited"
        status: "success"
        
    target_agents:
      - "ai-system-architect"
      - "ai-senior-backend-developer"
      - "ai-senior-frontend-developer"
      - "ai-senior-full-stack-developer"
      - "ai-senior-engineer"
      - "infrastructure-devops-manager"
      - "deployment-automation-master"
      - "ollama-integration-specialist"
      - "container-orchestrator-k3s"
      - "cicd-pipeline-orchestrator"
      - "secrets-vault-manager-vault"
      - "private-registry-manager-harbor"
      - "kali-security-specialist"
      - "security-pentesting-specialist"
      - "automated-incident-responder"
      - "emergency-shutdown-coordinator"
      - "resource-arbitration-agent"
      - "compute-scheduler-and-optimizer"
      - "hardware-resource-optimizer"
      - "cpu-only-hardware-optimizer"
      - "gpu-hardware-optimizer"
      - "ram-hardware-optimizer"
      - "deep-learning-brain-architect"
      - "deep-learning-brain-manager"
      - "deep-local-brain-builder"
      - "quantum-ai-researcher"
      - "autonomous-task-executor"
      - "goal-setting-and-planning-agent"
      - "cognitive-load-monitor"
      - "human-oversight-interface-agent"
      - "ethical-governor"
      
    success_criteria:
      error_rate_threshold: 0.3
      response_time_multiplier: 1.6
      memory_usage_multiplier: 1.25
      cpu_usage_multiplier: 1.2
      health_check_success_rate: 0.99
      ollama_success_rate: 0.97
      circuit_breaker_trips: 2
      task_completion_rate: 0.99
      system_stability_score: 0.95
      
    monitoring:
      metrics_interval: "60s"
      health_check_interval: "30s"
      rollback_check_interval: "120s"
      business_metrics_interval: "300s"
      
    rollback_triggers:
      - condition: "error_rate > 2%"
        severity: "critical"
        action: "immediate_rollback"
      - condition: "memory_usage > 80%"
        severity: "critical"
        action: "immediate_rollback"
      - condition: "task_failure_rate > 1%"
        severity: "high"
        action: "pause_and_evaluate"
      - condition: "system_stability_score < 0.9"
        severity: "high"
        action: "pause_and_evaluate"

  # Phase 4: Full deployment - All remaining agents
  complete:
    name: "Full Deployment"
    percentage: 100
    agent_count: 131
    duration: "75m"
    timeout: "90m"
    
    depends_on:
      - phase: "production"
        status: "success"
        
    # All remaining agents
    target_agents: "remaining"
    
    success_criteria:
      error_rate_threshold: 0.5
      response_time_multiplier: 1.5
      memory_usage_multiplier: 1.3
      cpu_usage_multiplier: 1.25
      health_check_success_rate: 0.99
      ollama_success_rate: 0.96
      circuit_breaker_trips: 3
      task_completion_rate: 0.99
      system_stability_score: 0.95
      deployment_success_rate: 1.0
      
    monitoring:
      metrics_interval: "90s"
      health_check_interval: "45s"
      rollback_check_interval: "180s"
      business_metrics_interval: "300s"
      full_system_check_interval: "600s"
      
    rollback_triggers:
      - condition: "error_rate > 1%"
        severity: "critical"
        action: "immediate_rollback"
      - condition: "memory_usage > 75%"
        severity: "critical"  
        action: "immediate_rollback"
      - condition: "system_wide_failure"
        severity: "critical"
        action: "immediate_rollback"

# Global configuration
global_settings:
  # Deployment behavior
  parallel_deployment_limit: 5
  deployment_batch_size: 3
  inter_batch_delay: "30s"
  
  # Resource management
  memory_safety_margin: 0.15  # 15% safety margin
  cpu_safety_margin: 0.1      # 10% safety margin
  
  # Ollama specific
  ollama_connection_timeout: "30s"
  ollama_request_timeout: "60s"
  ollama_retry_attempts: 3
  ollama_backoff_multiplier: 2
  
  # Health checks
  health_check_timeout: "10s"
  health_check_retries: 3
  health_check_endpoint: "/health"
  
  # Rollback configuration
  rollback_timeout: "180s"
  rollback_validation_timeout: "120s"
  rollback_max_attempts: 1
  
  # Monitoring
  metrics_retention: "24h"
  alert_cooldown: "300s"
  notification_channels:
    - "slack"
    - "email"
    - "webhook"

# Pre-deployment validation
validation:
  required_checks:
    - name: "base_agent_v2_tests"
      type: "unit_test"
      command: "python -m pytest /opt/sutazaiapp/agents/core/test_enhanced_agent.py"
    - name: "ollama_connectivity"
      type: "integration_test"
      command: "curl -f http://ollama:10104/api/tags"
    - name: "resource_availability"
      type: "system_check"
      command: "bash /opt/sutazaiapp/scripts/check-resources.sh"
    - name: "backup_verification"
      type: "backup_check"
      command: "bash /opt/sutazaiapp/scripts/verify-backup.sh"
    - name: "rollback_readiness"
      type: "rollback_test"
      command: "bash /opt/sutazaiapp/scripts/test-rollback.sh --dry-run"

# Post-deployment validation
post_validation:
  immediate_checks:
    timeout: "30m"
    checks:
      - "all_agents_healthy"
      - "task_processing_active"
      - "no_error_spikes"
      - "resource_usage_normal"
      - "ollama_integration_working"
      
  extended_checks:
    timeout: "4h"
    checks:
      - "performance_stable"
      - "no_memory_leaks"
      - "circuit_breaker_appropriate"
      - "connection_pool_efficient"
      - "long_running_tasks_complete"
      
  success_declaration:
    timeout: "4h"
    required_stability_period: "2h"
    final_validation_checks:
      - "all_success_metrics_achieved"
      - "no_rollback_triggers_activated"
      - "enhanced_capacity_verified"
      - "documentation_updated"