
services:
  mcp-server:
    build:
      context: ./mcp_server
    image: sutazai-mcp-server:latest
    container_name: sutazai-mcp-server
    env_file:
      - ./mcp_server/.env
    environment:
      # Fallbacks if .env not present
      - BACKEND_API_URL=${BACKEND_API_URL:-http://host.docker.internal:8000}
      - OLLAMA_URL=${OLLAMA_URL:-http://host.docker.internal:11434}
      - SEQUENTIAL_THINKING_IMAGE=${SEQUENTIAL_THINKING_IMAGE:-mcp/sequentialthinking}
      - MCP_HTTP_PORT=${MCP_HTTP_PORT:-3030}
    volumes:
      # Docker socket mount REMOVED for security - container escape risk
      # - /var/run/docker.sock:/var/run/docker.sock:rw  # SECURITY: Removed
      # Optional: live-reload local code during development
    user: "1000:1000"  # Changed from root to non-root user for security
    ports:
      - "3030:3030"
    healthcheck:
      test: ["CMD-SHELL", "node -e 'process.exit(0)' "]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped

  # Optional: MCP Inspector UI to exercise MCP via browser
  mcp-inspector:
    image: ghcr.io/modelcontextprotocol/inspector:latest
    container_name: mcp-inspector
    ports:
      - "6274:6274"
    environment:
      - PORT=6274
    restart: unless-stopped

networks:
  default:
    name: sutazai-mcp
