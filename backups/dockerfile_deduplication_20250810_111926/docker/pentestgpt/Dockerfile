FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    build-essential \
    python3-dev \
    wget \
    && rm -rf /var/lib/apt/lists/* && rm -rf /var/lib/apt/lists/* && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
RUN pip install --no-cache-dir \
    requests \
    beautifulsoup4 \
    openai \
    fastapi \
    uvicorn


# Create startup script
COPY main.py requirements.txt* ./
RUN if [ -f requirements.txt ]; then pip install --no-cache-dir -r requirements.txt; fi

# Create health check endpoint
RUN echo '#!/usr/bin/env python3' > /app/web_interface.py && \
    echo 'import http.server' >> /app/web_interface.py && \
    echo 'import socketserver' >> /app/web_interface.py && \
    echo 'import threading' >> /app/web_interface.py && \
    echo 'import json' >> /app/web_interface.py && \
    echo 'import os' >> /app/web_interface.py && \
    echo '' >> /app/web_interface.py && \
    echo 'class HealthHandler(http.server.SimpleHTTPRequestHandler):' >> /app/web_interface.py && \
    echo '    def do_GET(self):' >> /app/web_interface.py && \
    echo '        if self.path == "/health":' >> /app/web_interface.py && \
    echo '            self.send_response(200)' >> /app/web_interface.py && \
    echo '            self.send_header("Content-type", "application/json")' >> /app/web_interface.py && \
    echo '            self.end_headers()' >> /app/web_interface.py && \
    echo '            self.wfile.write(json.dumps({"status": "healthy", "agent": "pentestgpt"}).encode())' >> /app/web_interface.py && \
    echo '        else:' >> /app/web_interface.py && \
    echo '            self.send_response(404)' >> /app/web_interface.py && \
    echo '            self.end_headers()' >> /app/web_interface.py && \
    echo '' >> /app/web_interface.py && \
    echo 'def start_health_server():' >> /app/web_interface.py && \
    echo '    with socketserver.TCPServer(("", 8000), HealthHandler) as httpd:' >> /app/web_interface.py && \
    echo '        httpd.serve_forever()' >> /app/web_interface.py && \
    echo '' >> /app/web_interface.py && \
    echo 'if __name__ == "__main__":' >> /app/web_interface.py && \
    echo '    # Start health check server in background' >> /app/web_interface.py && \
    echo '    health_thread = threading.Thread(target=start_health_server)' >> /app/web_interface.py && \
    echo '    health_thread.daemon = True' >> /app/web_interface.py && \
    echo '    health_thread.start()' >> /app/web_interface.py && \
    echo '    ' >> /app/web_interface.py && \
    echo '    # Import and run main application' >> /app/web_interface.py && \
    echo '    import main' >> /app/web_interface.py && \
    echo '    main.run()' >> /app/web_interface.py

EXPOSE 8080
EXPOSE 8000


# Run as non-root user
USER nobody

# Run as non-root user
USER nobody

# Security: Create non-root user
RUN groupadd -r appuser && useradd -r -g appuser appuser \
    && mkdir -p /app && chown -R appuser:appuser /app
USER appuser

CMD ["python3", "web_interface.py"]
