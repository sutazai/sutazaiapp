version: '3.8'

# ============================================
# SutazAI Platform - Portainer Stack
# Production-Ready Unified Docker Compose
# Last Updated: 2025-11-13
# ============================================

networks:
  sutazai-network:
    name: sutazaiapp_sutazai-network
    external: true

volumes:
  postgres_data:
  redis_data:
  neo4j_data:
  neo4j_logs:
  neo4j_plugins:
  rabbitmq_data:
  consul_data:
  chromadb_data:
  qdrant_data:

services:
  # ============================================
  # CORE INFRASTRUCTURE
  # ============================================
  
  postgres:
    image: postgres:16-alpine
    container_name: sutazai-postgres
    restart: unless-stopped
    ports:
      - "10000:5432"
    networks:
      sutazai-network:
        ipv4_address: 172.20.0.10
    environment:
      POSTGRES_DB: jarvis_ai
      POSTGRES_USER: jarvis
      POSTGRES_PASSWORD: sutazai_secure_2024
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U jarvis -d jarvis_ai"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

  redis:
    image: redis:7-alpine
    container_name: sutazai-redis
    restart: unless-stopped
    ports:
      - "10001:6379"
    networks:
      sutazai-network:
        ipv4_address: 172.20.0.11
    command: >
      redis-server
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
      --save 60 1
      --appendonly yes
      --protected-mode no
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'

  neo4j:
    image: neo4j:5-community
    container_name: sutazai-neo4j
    restart: unless-stopped
    ports:
      - "10002:7474"
      - "10003:7687"
    networks:
      sutazai-network:
        ipv4_address: 172.20.0.12
    environment:
      NEO4J_AUTH: neo4j/sutazai2024
      NEO4J_server_memory_heap_initial__size: 128M
      NEO4J_server_memory_heap_max__size: 256M
      NEO4J_server_memory_pagecache_size: 64M
      NEO4J_dbms_security_procedures_unrestricted: apoc.*
      NEO4J_server_bolt_advertised__address: 172.20.0.12:7687
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_plugins:/plugins
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:7474 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 45s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.75'

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: sutazai-rabbitmq
    restart: unless-stopped
    ports:
      - "10004:5672"
      - "10005:15672"
    networks:
      sutazai-network:
        ipv4_address: 172.20.0.13
    environment:
      RABBITMQ_DEFAULT_USER: jarvis
      RABBITMQ_DEFAULT_PASS: sutazai2024
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_running"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  consul:
    image: hashicorp/consul:1.19
    container_name: sutazai-consul
    restart: unless-stopped
    ports:
      - "10006:8500"
      - "10007:8600/tcp"
      - "10007:8600/udp"
    networks:
      sutazai-network:
        ipv4_address: 172.20.0.14
    command: agent -server -ui -bootstrap-expect=1 -client=0.0.0.0 -bind=172.20.0.14
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'

  # ============================================
  # API GATEWAY
  # ============================================

  kong:
    image: kong:3.9
    container_name: sutazai-kong
    restart: unless-stopped
    ports:
      - "10008:8000"
      - "10009:8001"
    networks:
      sutazai-network:
        ipv4_address: 172.20.0.35
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: 172.20.0.10
      KONG_PG_PORT: 5432
      KONG_PG_DATABASE: kong
      KONG_PG_USER: jarvis
      KONG_PG_PASSWORD: sutazai_secure_2024
      KONG_PROXY_LISTEN: 0.0.0.0:8000
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_ADMIN_GUI_LISTEN: 0.0.0.0:8002
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # ============================================
  # VECTOR DATABASES
  # ============================================

  chromadb:
    image: ghcr.io/chroma-core/chroma:latest
    container_name: sutazai-chromadb
    restart: unless-stopped
    ports:
      - "10100:8000"
    networks:
      sutazai-network:
        ipv4_address: 172.20.0.20
    environment:
      CHROMA_SERVER_AUTHN_CREDENTIALS: ""
      CHROMA_SERVER_AUTHN_PROVIDER: ""
      IS_PERSISTENT: "TRUE"
      ANONYMIZED_TELEMETRY: "FALSE"
    volumes:
      - chromadb_data:/chroma/chroma
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  qdrant:
    image: qdrant/qdrant:v1.15.4
    container_name: sutazai-qdrant
    restart: unless-stopped
    ports:
      - "10101:6333"
      - "10102:6334"
    networks:
      sutazai-network:
        ipv4_address: 172.20.0.21
    volumes:
      - qdrant_data:/qdrant/storage
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  faiss:
    build:
      context: ./services/faiss
      dockerfile: Dockerfile
    image: sutazai-faiss:latest
    container_name: sutazai-faiss
    restart: unless-stopped
    ports:
      - "10103:8000"
    networks:
      sutazai-network:
        ipv4_address: 172.20.0.22
    environment:
      PORT: "8000"
      HOST: "0.0.0.0"
      LOG_LEVEL: "INFO"
      DIMENSION: "768"
      INDEX_TYPE: "Flat"
      METRIC: "L2"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # ============================================
  # APPLICATION LAYER
  # ============================================

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: sutazai-backend:latest
    container_name: sutazai-backend
    restart: unless-stopped
    ports:
      - "10200:8000"
    networks:
      sutazai-network:
        ipv4_address: 172.20.0.40
    environment:
      # Database
      POSTGRES_HOST: 172.20.0.10
      POSTGRES_PORT: "5432"
      POSTGRES_DB: jarvis_ai
      POSTGRES_USER: jarvis
      POSTGRES_PASSWORD: sutazai_secure_2024
      
      # Cache & Message Queue
      REDIS_HOST: 172.20.0.11
      REDIS_PORT: "6379"
      RABBITMQ_HOST: 172.20.0.13
      RABBITMQ_PORT: "5672"
      RABBITMQ_USER: jarvis
      RABBITMQ_PASS: sutazai2024
      
      # Services
      NEO4J_URI: bolt://172.20.0.12:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: sutazai2024
      CONSUL_HOST: 172.20.0.14
      CONSUL_PORT: "8500"
      KONG_ADMIN_URL: http://172.20.0.35:8001
      
      # Vector DBs
      CHROMADB_HOST: 172.20.0.20
      CHROMADB_PORT: "8000"
      QDRANT_HOST: 172.20.0.21
      QDRANT_PORT: "6333"
      FAISS_HOST: 172.20.0.22
      FAISS_PORT: "8000"
      
      # LLM
      OLLAMA_BASE_URL: http://host.docker.internal:11434
      DEFAULT_MODEL: tinyllama:latest
      
      # JWT
      SECRET_KEY: sutazai_jwt_secret_key_2024_production
      ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: "30"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      consul:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    deploy:
      resources:
        limits:
          memory: 1024M
          cpus: '1.0'

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: sutazai-frontend:latest
    container_name: sutazai-jarvis-frontend
    restart: unless-stopped
    ports:
      - "11000:11000"
    networks:
      sutazai-network:
        ipv4_address: 172.20.0.31
    environment:
      BACKEND_URL: http://172.20.0.40:8000
      BACKEND_WS_URL: ws://172.20.0.40:8000
      STREAMLIT_SERVER_PORT: "11000"
      STREAMLIT_SERVER_ADDRESS: "0.0.0.0"
      STREAMLIT_SERVER_HEADLESS: "true"
      STREAMLIT_BROWSER_GATHER_USAGE_STATS: "false"
      ENABLE_VOICE_COMMANDS: "false"
      SHOW_DOCKER_STATS: "false"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11000/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1024M
          cpus: '1.0'
