version: '3.8'

services:
  # Auto-scaling simulator for development
  autoscaler:
    image: python:3.11-slim
    container_name: sutazai-autoscaler
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./deployment/autoscaling/swarm/swarm-autoscaler.py:/app/autoscaler.py
    environment:
      - PROMETHEUS_URL=http://prometheus:9090
      - MIN_REPLICAS=1
      - MAX_REPLICAS=5
      - PLATFORM=compose
    command: >
      sh -c "pip install docker aiohttp prometheus-client &&
             python /app/autoscaler.py"
    networks:
      - sutazai_default
    restart: unless-stopped

  # Load balancer
  nginx:
    image: nginx:alpine
    container_name: sutazai-nginx
    ports:
      - "8080:80"
    volumes:
      - ./deployment/autoscaling/swarm/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./deployment/autoscaling/swarm/upstream.conf:/etc/nginx/conf.d/upstream.conf:ro
    depends_on:
      - backend
    networks:
      - sutazai_default
    restart: unless-stopped

networks:
  sutazai_default:
    external: true
