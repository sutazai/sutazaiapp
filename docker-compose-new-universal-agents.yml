version: '3.8'

services:
  # Redis - Message Bus and Registry Storage
  universal-agent-redis:
    image: redis:7-alpine
    container_name: sutazai-universal-agent-redis
    restart: unless-stopped
    ports:
      - "6380:6379"  # Different port to avoid conflicts
    volumes:
      - universal_agent_redis_data:/data
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - universal-agent-network

  # Ollama - Local AI Models
  universal-agent-ollama:
    image: ollama/ollama:latest
    container_name: sutazai-universal-agent-ollama
    restart: unless-stopped
    ports:
      - "11435:11434"  # Different port to avoid conflicts
    volumes:
      - universal_agent_ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_MODELS=/root/.ollama/models
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - universal-agent-network

  # Ollama Model Puller - Downloads required models
  universal-ollama-models:
    image: ollama/ollama:latest
    container_name: sutazai-universal-ollama-models
    depends_on:
      - universal-agent-ollama
    volumes:
      - universal_agent_ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=universal-agent-ollama:11434
    command: >
      sh -c "
        echo 'Waiting for Ollama to be ready...' &&
        sleep 30 &&
        ollama pull codellama &&
        ollama pull llama2 &&
        ollama pull mistral &&
        echo 'Models downloaded successfully'
      "
    networks:
      - universal-agent-network
    restart: "no"

  # Universal Agent System - Main Application
  universal-agent-system:
    build:
      context: .
      dockerfile: docker/universal-agents/Dockerfile
    container_name: sutazai-universal-agent-system
    restart: unless-stopped
    depends_on:
      - universal-agent-redis
      - universal-agent-ollama
      - universal-ollama-models
    ports:
      - "8910:8910"  # Management API
      - "9100:9100"  # Metrics
      - "9101:9101"  # Health checks
    volumes:
      - ./config:/app/config:ro
      - ./logs:/app/logs
      - ./backend:/app/backend:ro
      - ./scripts:/app/scripts:ro
    environment:
      - REDIS_URL=redis://universal-agent-redis:6379
      - OLLAMA_URL=http://universal-agent-ollama:11434
      - PYTHONPATH=/app
      - LOG_LEVEL=INFO
    command: python scripts/start_universal_agent_system.py
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9101/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - universal-agent-network

volumes:
  universal_agent_redis_data:
    driver: local
  universal_agent_ollama_data:
    driver: local

networks:
  universal-agent-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16